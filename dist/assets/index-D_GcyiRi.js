var e=Object.defineProperty,t=(t,s,n)=>((t,s,n)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[s]=n)(t,"symbol"!=typeof s?s+"":s,n);import{T as s,a as n,b as i,L as a,c as r,F as o,M as c,V as l,C as h,d,S as u,e as m,P as f,D as p,f as g,g as v,I as A,Q as y,h as E,O as T,i as _,j as w,B as R,k as x,l as I,N as b,m as M,n as S,o as C,p as L,R as k,q as F,r as P,s as N,t as D,u as O,v as B,w as H,x as z,y as j,z as U,A as G,E as K,G as V,H as $,J as q,K as X,U as W,W as Y,X as J,Y as Q,Z,_ as ee,$ as te,a0 as se,a1 as ne,a2 as ie,a3 as ae,a4 as re,a5 as oe,a6 as ce,a7 as le,a8 as he,a9 as de,aa as ue,ab as me,ac as fe,ad as pe,ae as ge,af as ve,ag as Ae,ah as ye,ai as Ee}from"./three-C7pa0Fha.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const s of e)if("childList"===s.type)for(const e of s.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();class Te{constructor(){this.constraints={facingMode:"user",width:{ideal:1280},height:{ideal:720},advanced:[{exposureMode:"continuous"},{exposureCompensation:0},{whiteBalanceMode:"continuous"},{focusMode:"continuous"},{colorTemperature:5e3},{iso:400}]}}async requestCameraStream(){try{console.log("[CAMERA] Requesting stream with advanced constraints...");const e=await navigator.mediaDevices.getUserMedia({video:this.constraints});return this._logStreamInfo(e),e}catch(e){console.warn("[CAMERA] Advanced constraints failed:",e.message);try{console.log("[CAMERA] Falling back to basic constraints...");const e=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user",width:{ideal:1280},height:{ideal:720}}});return this._logStreamInfo(e),e}catch(t){throw console.error("[CAMERA] Basic constraints failed:",t),new Error("Camera access denied or not supported. Please allow camera permissions.")}}}async requestCameraStreamEnhanced(){try{const t=(await navigator.mediaDevices.enumerateDevices()).filter(e=>"videoinput"===e.kind);if(console.log(`[CAMERA] Found ${t.length} video devices`),0===t.length)throw new Error("No camera devices found");const s=[{name:"Front camera ideal",constraints:{video:{facingMode:{ideal:"user"},width:{ideal:1280},height:{ideal:720},frameRate:{ideal:30}}}},{name:"Front camera exact",constraints:{video:{facingMode:{exact:"user"},width:{exact:1280},height:{exact:720},frameRate:{ideal:30}}}},{name:"Any camera ideal",constraints:{video:{width:{ideal:1280},height:{ideal:720},frameRate:{ideal:30}}}},{name:"Front camera low res",constraints:{video:{facingMode:{ideal:"user"},width:{ideal:640},height:{ideal:480},frameRate:{ideal:15}}}},{name:"Minimal constraints",constraints:{video:!0}}];for(const n of s)try{console.log(`[CAMERA] Trying strategy: ${n.name}`);const e=await navigator.mediaDevices.getUserMedia(n.constraints);return this._logStreamInfo(e),e}catch(e){console.warn(`[CAMERA] Strategy "${n.name}" failed:`,e.message);continue}throw new Error("All camera strategies failed")}catch(e){console.error("[CAMERA] Enhanced camera request failed:",e);try{console.log("[CAMERA] Using no constraints as final fallback...");const e=await navigator.mediaDevices.getUserMedia({video:{}});return this._logStreamInfo(e),e}catch(t){throw console.error("[CAMERA] All camera attempts failed:",t),new Error("Unable to access camera. Please check permissions and try again.")}}}_logStreamInfo(e){const t=e.getVideoTracks()[0];if(t&&t.getSettings){const e=t.getSettings();console.log("[CAMERA] Stream settings:",{width:e.width,height:e.height,frameRate:e.frameRate,facingMode:e.facingMode})}}async checkCapabilities(){try{const e=(await navigator.mediaDevices.enumerateDevices()).filter(e=>"videoinput"===e.kind);console.log(`[CAMERA] Found ${e.length} camera(s)`);const t=(await this.requestCameraStream()).getVideoTracks()[0];if(t&&t.getCapabilities){const e=t.getCapabilities();console.log("[CAMERA] Capabilities:",{exposureModes:e.exposureMode,focusModes:e.focusMode,whiteBalanceModes:e.whiteBalanceMode,isoRanges:e.iso})}return t.stop(),!0}catch(e){return console.error("[CAMERA] Capability check failed:",e),!1}}adjustExposure(e,t){if(!e||!e.applyConstraints)return console.warn("[CAMERA] Cannot adjust exposure: invalid track"),Promise.resolve();const s={advanced:[]};return t.exposureMode&&s.advanced.push({exposureMode:t.exposureMode}),void 0!==t.exposureCompensation&&s.advanced.push({exposureCompensation:t.exposureCompensation}),t.focusMode&&s.advanced.push({focusMode:t.focusMode}),t.whiteBalanceMode&&s.advanced.push({whiteBalanceMode:t.whiteBalanceMode}),e.applyConstraints({advanced:s.advanced})}}const _e={},we=function(e,t,s){let n=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const e=document.querySelector("meta[property=csp-nonce]"),s=(null==e?void 0:e.nonce)||(null==e?void 0:e.getAttribute("nonce"));n=Promise.allSettled(t.map(e=>{if((e=function(e){return"/"+e}(e))in _e)return;_e[e]=!0;const t=e.endsWith(".css"),n=t?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${e}"]${n}`))return;const i=document.createElement("link");return i.rel=t?"stylesheet":"modulepreload",t||(i.as="script"),i.crossOrigin="",i.href=e,s&&i.setAttribute("nonce",s),document.head.appendChild(i),t?new Promise((t,s)=>{i.addEventListener("load",t),i.addEventListener("error",()=>s(new Error(`Unable to preload CSS for ${e}`)))}):void 0}))}function i(e){const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return n.then(t=>{for(const e of t||[])"rejected"===e.status&&i(e.reason);return e().catch(i)})};class Re{constructor(){this.samples=[],this.maxSamples=15,this.minSamples=8,this.calibratedFocal=null,this.lastCalibrationTime=0,this.REAL_IPD_MM=63,this.EYE_INDICES={left:33,right:263}}estimateFocalLength(e,t){try{const s=e[this.EYE_INDICES.left],n=e[this.EYE_INDICES.right];if(!s||!n)return null;const i=Math.hypot((n.x-s.x)*t,(n.y-s.y)*t);if(i<20||i>200)return null;const a=i*this.REAL_IPD_MM/30;return a<500||a>3e3?null:a}catch(s){return console.error("[CALIB] Focal length estimation failed:",s),null}}addSample(e){return!!e&&(this.samples.push({value:e,timestamp:performance.now()}),this.samples.length>this.maxSamples&&this.samples.shift(),console.log(`[CALIB] Added sample: ${e.toFixed(1)}px (${this.samples.length}/${this.maxSamples})`),!0)}getCalibratedFocalLength(){if(this.samples.length<this.minSamples)return null;let e=0,t=0;const s=performance.now();for(const a of this.samples){const n=s-a.timestamp,i=Math.exp(-n/5e3);e+=a.value*i,t+=i}const n=e/t;if(n<500||n>3e3)return console.warn("[CALIB] Invalid calibrated focal length:",n),null;const i=this._calculateVariance();return i>1e4?(console.warn("[CALIB] High variance detected:",i),null):(this.calibratedFocal=n,this.lastCalibrationTime=s,console.log(`[CALIB] ✅ Calibrated focal length: ${n.toFixed(1)}px (variance: ${i.toFixed(1)})`),n)}_calculateVariance(){if(this.samples.length<2)return 0;const e=this.samples.reduce((e,t)=>e+t.value,0)/this.samples.length;return this.samples.reduce((t,s)=>t+Math.pow(s.value-e,2),0)/this.samples.length}isStable(){if(!this.calibratedFocal)return!1;const e=this._calculateVariance(),t=performance.now()-this.lastCalibrationTime;return e<5e3&&t<1e4}reset(){this.samples=[],this.calibratedFocal=null,this.lastCalibrationTime=0,console.log("[CALIB] Reset calibration state")}getStatus(){return{samples:this.samples.length,maxSamples:this.maxSamples,minSamples:this.minSamples,calibrated:!!this.calibratedFocal,focalLength:this.calibratedFocal,stable:this.isStable(),variance:this._calculateVariance()}}}class xe{constructor(){this.storageKey="vto_camera_profiles",this.profiles=this._loadProfiles()}_loadProfiles(){try{const e=localStorage.getItem(this.storageKey);return e?JSON.parse(e):{}}catch(e){return console.error("[PROFILE] Failed to load profiles:",e),{}}}_saveProfiles(){try{localStorage.setItem(this.storageKey,JSON.stringify(this.profiles))}catch(e){console.error("[PROFILE] Failed to save profiles:",e)}}_generateProfileKey(e,t,s){return`${e}_${t}x${s}`}save(e,t,s,n){const i=this._generateProfileKey(e,s,n);this.profiles[i]={deviceId:e,focalLength:t,width:s,height:n,timestamp:Date.now(),version:"5.0"},this._saveProfiles(),console.log(`[PROFILE] Saved profile: ${i} (focal: ${t.toFixed(1)}px)`)}load(e,t,s){const n=this._generateProfileKey(e,t,s),i=this.profiles[n];if(!i)return console.log(`[PROFILE] No profile found for: ${n}`),null;return Date.now()-i.timestamp>2592e6?(console.log(`[PROFILE] Profile expired for: ${n}`),delete this.profiles[n],this._saveProfiles(),null):(console.log(`[PROFILE] Loaded profile: ${n} (focal: ${i.focalLength.toFixed(1)}px)`),i)}getAllProfiles(){return Object.entries(this.profiles).map(([e,t])=>({key:e,...t}))}clearAll(){this.profiles={},this._saveProfiles(),console.log("[PROFILE] Cleared all profiles")}clearExpired(){const e=Date.now();let t=0;for(const[s,n]of Object.entries(this.profiles))e-n.timestamp>2592e6&&(delete this.profiles[s],t++);return t>0&&(this._saveProfiles(),console.log(`[PROFILE] Cleared ${t} expired profiles`)),t}export(){return JSON.stringify(this.profiles,null,2)}import(e){try{const t=JSON.parse(e);return this.profiles={...this.profiles,...t},this._saveProfiles(),console.log("[PROFILE] Imported profiles successfully"),!0}catch(t){return console.error("[PROFILE] Failed to import profiles:",t),!1}}}class Ie{constructor(){this.cameraIntrinsics=null,this.distortionCoeffs=null,this.modelPoints=null,this.imagePoints=null,this.rvec=null,this.tvec=null,this._initializeModelPoints(),this._initializeDistortionCoefficients()}_initializeModelPoints(){this.modelPoints=new cv.Mat(6,3,cv.CV_64FC1);const e=[[0,0,0],[0,-330,-65],[-225,170,-135],[225,170,-135],[-150,-150,-125],[150,-150,-125]];for(let t=0;t<e.length;t++)this.modelPoints.data64F[3*t]=e[t][0],this.modelPoints.data64F[3*t+1]=e[t][1],this.modelPoints.data64F[3*t+2]=e[t][2]}_initializeDistortionCoefficients(){this.distortionCoeffs=new cv.Mat(5,1,cv.CV_64FC1);for(let e=0;e<5;e++)this.distortionCoeffs.data64F[e]=0}setCameraIntrinsics(e){this.cameraIntrinsics=e,console.log("[POSE] Camera intrinsics set:",{focal:e.focalLength.toFixed(1),cx:e.cx,cy:e.cy})}estimate(e,t={}){if(!this.cameraIntrinsics)return console.warn("[POSE] Camera intrinsics not set"),null;if(!window.opencvReady||"undefined"==typeof cv)return console.warn("[POSE] OpenCV not ready"),null;try{const s=this._extractImagePoints(e,t);if(!s)return null;const n=new cv.Mat(3,3,cv.CV_64FC1);n.data64F[0]=this.cameraIntrinsics.focalLength,n.data64F[1]=0,n.data64F[2]=this.cameraIntrinsics.cx,n.data64F[3]=0,n.data64F[4]=this.cameraIntrinsics.focalLength,n.data64F[5]=this.cameraIntrinsics.cy,n.data64F[6]=0,n.data64F[7]=0,n.data64F[8]=1;const i=new cv.Mat,a=new cv.Mat,r=cv.solvePnP(this.modelPoints,s,n,this.distortionCoeffs,i,a,!1,cv.SOLVEPNP_ITERATIVE);if(s.delete(),n.delete(),!r)return i.delete(),a.delete(),null;const o=Array.from(i.data64F),c=Array.from(a.data64F);i.delete(),a.delete();return{rvec:o,tvec:c,confidence:this._calculateConfidence(e,o,c),timestamp:performance.now()}}catch(s){return console.error("[POSE] Estimation failed:",s),null}}_extractImagePoints(e,t){try{const s=new cv.Mat(6,2,cv.CV_64FC1),n=t.width||1280,i=t.height||720,a=[1,152,33,263,61,291];for(let t=0;t<a.length;t++){const r=e[a[t]];if(!r)return s.delete(),null;s.data64F[2*t]=r.x*n,s.data64F[2*t+1]=r.y*i}return s}catch(s){return console.error("[POSE] Failed to extract image points:",s),null}}_calculateConfidence(e,t,s){try{const n=this._projectPoints(t,s);if(!n)return.5;const i=this.cameraIntrinsics.width,a=this.cameraIntrinsics.height,r=[1,152,33,263,61,291];let o=0,c=0;for(let t=0;t<r.length;t++){const s=e[r[t]];if(!s)continue;const l=s.x*i,h=s.y*a,d=n.data64F[2*t],u=n.data64F[2*t+1];o+=Math.sqrt(Math.pow(l-d,2)+Math.pow(h-u,2)),c++}if(n.delete(),0===c)return.5;const l=o/c;return Math.max(0,Math.min(1,1-l/50))}catch(n){return console.error("[POSE] Confidence calculation failed:",n),.5}}_projectPoints(e,t){try{const s=new cv.Mat(3,3,cv.CV_64FC1);s.data64F[0]=this.cameraIntrinsics.focalLength,s.data64F[1]=0,s.data64F[2]=this.cameraIntrinsics.cx,s.data64F[3]=0,s.data64F[4]=this.cameraIntrinsics.focalLength,s.data64F[5]=this.cameraIntrinsics.cy,s.data64F[6]=0,s.data64F[7]=0,s.data64F[8]=1;const n=new cv.Mat(3,1,cv.CV_64FC1),i=new cv.Mat(3,1,cv.CV_64FC1);for(let r=0;r<3;r++)n.data64F[r]=e[r],i.data64F[r]=t[r];const a=new cv.Mat;return cv.projectPoints(this.modelPoints,n,i,s,this.distortionCoeffs,a),s.delete(),n.delete(),i.delete(),a}catch(s){return console.error("[POSE] Point projection failed:",s),null}}destroy(){this.modelPoints&&(this.modelPoints.delete(),this.modelPoints=null),this.distortionCoeffs&&(this.distortionCoeffs.delete(),this.distortionCoeffs=null)}}class be{constructor(){this.stateDim=6,this.measurementDim=6,this.controlDim=0,this.kalman=null,this.measurement=null,this.initialized=!1,this._initializeKalman()}_initializeKalman(){if(window.opencvReady&&"undefined"!=typeof cv)try{this.kalman=new cv.KalmanFilter(this.stateDim,this.measurementDim,this.controlDim,cv.CV_64F);const e=.033,t=new cv.Mat(this.stateDim,this.stateDim,cv.CV_64F);for(let r=0;r<6;r++)t.data64F[r*this.stateDim+r]=1,r<3&&(t.data64F[r*this.stateDim+r+6]=e);this.kalman.transitionMatrix=t,t.delete();const s=new cv.Mat(this.measurementDim,this.stateDim,cv.CV_64F);for(let r=0;r<6;r++)s.data64F[r*this.stateDim+r]=1;this.kalman.measurementMatrix=s,s.delete();const n=cv.Mat.eye(this.stateDim,this.stateDim,cv.CV_64F);for(let r=0;r<6;r++)n.data64F[r*this.stateDim+r]=r<3?.01:1;this.kalman.processNoiseCov=n,n.delete();const i=cv.Mat.eye(this.measurementDim,this.measurementDim,cv.CV_64F);for(let r=0;r<6;r++)i.data64F[r*this.measurementDim+r]=r<3?.1:10;this.kalman.measurementNoiseCov=i,i.delete();const a=cv.Mat.eye(this.stateDim,this.stateDim,cv.CV_64F);for(let r=0;r<6;r++)a.data64F[r*this.stateDim+r]=1e3;this.kalman.errorCovPost=a,a.delete(),this.measurement=new cv.Mat(this.measurementDim,1,cv.CV_64F),console.log("[FILTER] Kalman filter initialized")}catch(e){console.error("[FILTER] Failed to initialize Kalman filter:",e)}else console.warn("[FILTER] OpenCV not ready for Kalman filter")}filter(e){if(!(this.kalman&&e&&e.rvec&&e.tvec))return e;try{for(let i=0;i<3;i++)this.measurement.data64F[i]=e.rvec[i],this.measurement.data64F[i+3]=e.tvec[i];const t=this.kalman.predict(),s=this.kalman.correct(this.measurement),n={rvec:[s.data64F[0],s.data64F[1],s.data64F[2]],tvec:[s.data64F[3],s.data64F[4],s.data64F[5]],confidence:e.confidence,timestamp:e.timestamp};return t.delete(),s.delete(),this.initialized=!0,n}catch(t){return console.error("[FILTER] Kalman filtering failed:",t),e}}reset(){if(this.kalman){const e=cv.Mat.zeros(this.stateDim,1,cv.CV_64F);this.kalman.statePost=e,e.delete()}this.initialized=!1,console.log("[FILTER] Kalman filter reset")}destroy(){this.kalman&&(this.kalman.delete(),this.kalman=null),this.measurement&&(this.measurement.delete(),this.measurement=null)}}class Me{constructor(){this.alpha=.3,this.filteredPose=null,this.initialized=!1}filter(e){if(!e||!e.rvec||!e.tvec)return e;if(!this.initialized)return this.filteredPose={rvec:[...e.rvec],tvec:[...e.tvec],confidence:e.confidence,timestamp:e.timestamp},this.initialized=!0,this.filteredPose;try{for(let t=0;t<3;t++)this.filteredPose.rvec[t]=this.alpha*e.rvec[t]+(1-this.alpha)*this.filteredPose.rvec[t],this.filteredPose.tvec[t]=this.alpha*e.tvec[t]+(1-this.alpha)*this.filteredPose.tvec[t];return this.filteredPose.confidence=e.confidence,this.filteredPose.timestamp=e.timestamp,this.filteredPose}catch(t){return console.error("[FILTER] EMA filtering failed:",t),e}}reset(){this.filteredPose=null,this.initialized=!1,console.log("[FILTER] EMA filter reset")}setAlpha(e){this.alpha=Math.max(.1,Math.min(.9,e)),console.log(`[FILTER] EMA alpha set to: ${this.alpha}`)}}const Se=500,Ce=-7.8,Le=.92,ke=182;const Fe=8.5,Pe=0,Ne=25,De=.6;function Oe(e,t={}){try{if(!e)return{angle:Fe,confidence:.3,hasEars:!1,method:"fallback"};const s=e[7],n=e[8],i=e[11],a=e[12];if(!(s&&n&&i&&a))return{angle:Fe,confidence:.2,hasEars:!1,method:"missing_landmarks"};const r=Math.abs(n.x-s.x),o=(s.y+n.y)/2,c=Math.abs(a.x-i.x),l=r/c;let h=function(e,t){let s=Fe;e>.8?s+=6:e>.6?s+=3:s-=2;t<.4?s+=1:t>.6&&(s-=1);return s}(l,o);void 0!==t.roll&&(h+=t.roll*(180/Math.PI)*.1);const d=Math.max(Pe,Math.min(Ne,h)),u=function(e,t){try{const s=e[7],n=e[8];let i=Math.min(s.visibility||.5,n.visibility||.5);i*=t>.3&&t<1.2?1.2:.7;return Math.abs(s.y-n.y)<.1&&(i*=1.1),Math.min(1,Math.max(0,i))}catch(s){return console.error("[EAR] Confidence calculation failed:",s),.1}}(e,l);return{angle:d,confidence:u,hasEars:u>De,method:"ear_detection",measurements:{earSpread:r,normalizedEarSpread:l,earHeight:o,shoulderWidth:c,headRoll:t.roll||0}}}catch(s){return console.error("[EAR] Temple angle calculation failed:",s),{angle:Fe,confidence:.1,hasEars:!1,method:"error"}}}const Be=20,He=.1,ze=.05;function je(e){try{const t=function(e){try{const t=[10,6,1,2,18,172,398],s=[];for(const n of t){const t=e[n];t&&t.visibility>.5&&s.push({x:t.x,y:t.y,z:t.z,visibility:t.visibility})}return function(e,t){if(e.length<2)return e;const s=[],n=(e.length-1)/(t-1);for(let i=0;i<t;i++){const t=i*n,a=Math.floor(t),r=Math.ceil(t),o=t-a;if(a===r)s.push(e[a]);else{const t=e[a],n=e[r];s.push({x:t.x+o*(n.x-t.x),y:t.y+o*(n.y-t.y),z:t.z+o*(n.z-t.z),visibility:Math.min(t.visibility,n.visibility)})}}return s}(s,Be)}catch(t){return console.error("[PROFILE] Profile extraction failed:",t),null}}(e);if(!t||t.length<5)return null;const s=function(e){try{if(e.length<3)return 0;let t=0,s=0;for(let n=1;n<e.length-1;n++){const i=e[n-1],a=e[n],r=e[n+1],o={x:i.x-a.x,y:i.y-a.y},c={x:r.x-a.x,y:r.y-a.y},l=o.x*c.x+o.y*c.y,h=Math.sqrt(o.x*o.x+o.y*o.y),d=Math.sqrt(c.x*c.x+c.y*c.y);if(h>0&&d>0){const e=l/(h*d),n=Math.acos(Math.max(-1,Math.min(1,e)));t+=Math.PI-n,s++}}return s>0?t/s:0}catch(t){return console.error("[PROFILE] Curvature calculation failed:",t),0}}(t),n=function(e){try{return e>2*He?"round":e>He?"oval":e>.5*He?"square":"oblong"}catch(t){return console.error("[PROFILE] Face shape classification failed:",t),"unknown"}}(s),i=function(e,t){try{let s=10;switch(t){case"round":s=12;break;case"oval":s=10;break;case"square":s=8;break;case"oblong":s=6}const n=s+20*(e-ze);return Math.max(0,Math.min(20,n))}catch(s){return console.error("[PROFILE] Wrap angle calculation failed:",s),10}}(s,n);return{curvature:s,faceShape:n,wrapAngle:i,confidence:function(e){try{if(!e||0===e.length)return 0;const t=e.reduce((e,t)=>e+(t.visibility||0),0)/e.length,s=e.length>=10?.2:0;return Math.min(1,t+s)}catch(t){return console.error("[PROFILE] Confidence calculation failed:",t),.1}}(t),profilePoints:t,measurements:{noseBridgeHeight:Ue(t),cheekProminence:Ge(t),jawAngle:Ke(t)}}}catch(t){return console.error("[PROFILE] Face profile estimation failed:",t),null}}function Ue(e){try{if(e.length<3)return 0;const t=e[1],s=e[2];return t&&s?Math.abs(s.y-t.y):0}catch(t){return console.error("[PROFILE] Nose bridge measurement failed:",t),0}}function Ge(e){try{if(e.length<4)return 0;const t=e[Math.floor(.4*e.length)];return t?Math.abs(t.z||0):0}catch(t){return console.error("[PROFILE] Cheek prominence measurement failed:",t),0}}function Ke(e){try{if(e.length<3)return 0;const t=e[e.length-3],s=e[e.length-2],n=e[e.length-1];if(!t||!s||!n)return 0;const i={x:s.x-t.x,y:s.y-t.y},a={x:n.x-t.x,y:n.y-t.y},r=i.x*a.x+i.y*a.y,o=Math.sqrt(i.x*i.x+i.y*i.y),c=Math.sqrt(a.x*a.x+a.y*a.y);if(o>0&&c>0){const e=r/(o*c);return Math.acos(Math.max(-1,Math.min(1,e)))*(180/Math.PI)}return 0}catch(t){return console.error("[PROFILE] Jaw angle measurement failed:",t),0}}class Ve{constructor(e){this.tracker=e}_initEnhancedTracking(){console.log("[TRACKER] Enhanced tracking not available in this version")}_onEnhancedTrackingResults(e,t){e&&t&&(this.tracker.multiAlgorithmConfidence=Math.min(e.confidence,t.confidence))}_processEnhancedTracking(e,t){this._processStandardTracking(e,t)}_processStandardTracking(e,t){const s=this.tracker._estimateHeadPose(e);if(!s)return this.tracker._handleTrackingLoss();const n=this.tracker.poseFilter.filter(s),i=computeSellionOffset(e,this.tracker.cameraIntrinsics,n.tvec),a=computeTempleWidth(e,this.tracker.video.videoWidth),r=estimateFaceProfile(e);if(!i||!a)return this.tracker._handleTrackingLoss();const o=computeTempleAngle(t,{roll:this.tracker._computeHeadRoll(e)}),c=500/Math.abs(n.tvec[2]),l=c*a.scale*.92,h=this.tracker._calculateLandmarkConfidence(e);let d=Math.min(s.confidence||.9,i.confidence,a.confidence,r.confidence||1,h);o.confidence&&(d=Math.min(d,o.confidence)),this.tracker.currentTransform={rvec:n.rvec,tvec:n.tvec,scale:{x:l,y:c,z:c},sellionOffset:i,templeAngle:o.angle,templeAngleData:o,faceProfile:r,confidence:d,effectiveConfidence:d*("CALIBRATED"===this.tracker.calibrationState?1:.6),calibrationState:this.tracker.calibrationState,trackingState:"TRACKING",hasEarDetection:!!t,frameCount:this.tracker.frameCount,enhancedTracking:!1},this.tracker.trackingState="TRACKING",this.tracker._notifyCallbacks()}}class $e{constructor(e,s,n={}){t(this,"_onFaceMeshResults",e=>{var t;if(!(null==(t=e.multiFaceLandmarks)?void 0:t[0]))return this._handleTrackingLoss();const s=e.multiFaceLandmarks[0];if(!this._validateLandmarks(s))return this._handleTrackingLoss();this._currentFaceLandmarks=s,this._currentFaceResults=e,this.hasHolistic&&this._currentPoseLandmarks||this._processTrackingData(s,null)}),t(this,"_onHolisticResults",e=>{e.poseLandmarks?(this._currentPoseLandmarks=e.poseLandmarks,this._currentFaceLandmarks&&this._processTrackingData(this._currentFaceLandmarks,e.poseLandmarks)):this._currentPoseLandmarks=null}),t(this,"_onEnhancedTrackingResults",(e,t)=>{e&&t&&(this.multiAlgorithmConfidence=Math.min(e.confidence,t.confidence))}),this.video=e,this.canvas=s,this.ctx=s.getContext("2d"),this.callbacks=n,this.frameCount=0,this.trackingState="INITIALIZING",this.currentTransform=null,this.lossStartTime=0,this.calibrator=new Re,this.profileMgr=new xe,this.cameraIntrinsics=null,this.calibrationState="LOADING",this.deviceId=this._getDeviceId(),this.poseFilter="high"===this._getDeviceTier()?new be:new Me,this.faceMesh=null,this.holistic=null,this.hasHolistic=!1,this.poseEstimator=null,this._currentFaceLandmarks=null,this._currentPoseLandmarks=null,this._currentFaceResults=null,this.isInitialized=!1,this.initializationError=null,this.initializationPromise=this._initializeSystems(),this.enhancedMethods=new Ve(this)}async _initializeSystems(){try{const[e,t]=await Promise.allSettled([this._initMediaPipe(),this._initHolistic()]);if("rejected"===e.status)throw e.reason;"rejected"===t.status&&(this.hasHolistic=!1,console.warn("[TRACKER] Holistic initialization failed:",t.reason)),this._initPoseEstimator(),this._loadCameraProfile(),this.isInitialized=!0}catch(e){this.initializationError=e,this.isInitialized=!1,console.error("[TRACKER] Initialization failed:",e)}}_getDeviceId(){return`${navigator.userAgent}_${screen.width}x${screen.height}_${Date.now()}`}_getDeviceTier(){const e=navigator.hardwareConcurrency&&navigator.hardwareConcurrency>=8,t=(navigator.deviceMemory||0)>=6;return e||t?"high":"low"}async _initMediaPipe(){try{const e=await we(()=>import("./mediapipe-TByOaUwE.js").then(e=>e.f),[]);this.faceMesh=new e.FaceMesh({locateFile:e=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${e}`,modelComplexity:1,maxNumFaces:1,refineLandmarks:!0,minDetectionConfidence:.5,minTrackingConfidence:.85}),this.faceMesh.onResults(this._onFaceMeshResults.bind(this)),console.log("[TRACKER] FaceMesh initialized")}catch(e){throw console.error("[TRACKER] Failed to initialize FaceMesh:",e),e}}async _initHolistic(){try{const e=await we(()=>import("./mediapipe-TByOaUwE.js").then(e=>e.h),[]);this.holistic=new e.Holistic({locateFile:e=>`https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${e}`,modelComplexity:0,smoothLandmarks:!0,minDetectionConfidence:.5,minTrackingConfidence:.8,refineFaceLandmarks:!0}),this.holistic.onResults(this._onHolisticResults.bind(this)),this.hasHolistic=!0,console.log("[TRACKER] Holistic initialized (ear detection enabled)")}catch(e){console.warn("[TRACKER] Holistic not available:",e.message),this.hasHolistic=!1}}_initPoseEstimator(){this.poseEstimator=new Ie}_loadCameraProfile(){var e,t;const s=this.video.videoWidth||1280,n=this.video.videoHeight||720,i=this.profileMgr.load(this.deviceId,s,n);(null==i?void 0:i.focal)?(this.cameraIntrinsics={focalLength:i.focal,cx:s/2,cy:n/2,width:s,height:n},this.calibrationState="CALIBRATED",console.log(`[CALIB] Loaded cached profile: ${i.focal.toFixed(1)}px`),null==(t=(e=this.callbacks).onCalibrated)||t.call(e)):(this.calibrationState="CALIBRATING",console.log("[CALIB] Starting runtime calibration"))}async processFrame(e){if(this.video.readyState<2)return null;if(!window.opencvReady||"undefined"==typeof cv)return null;if(!this.isInitialized&&(this.initializationPromise&&await this.initializationPromise,!this.isInitialized))return null;if(this.initializationError)return null;if(!this.faceMesh)return null;try{const e=[this.faceMesh.send({image:this.video})];this.hasHolistic&&this.holistic&&e.push(this.holistic.send({image:this.video})),await Promise.all(e)}catch(t){console.error("[TRACKER] Frame processing error:",t),this._handleTrackingLoss()}return this.frameCount++,this.currentTransform}_processTrackingData(e,t){"CALIBRATING"===this.calibrationState&&this._attemptCalibration(e),this._processStandardTracking(e,t)}_processStandardTracking(e,t){const s=this._estimateHeadPose(e);if(!s)return this._handleTrackingLoss();const n=this.poseFilter.filter(s),i=function(e,t,s){try{const t=e[1],n=e[6],i=e[33],a=e[263];if(!(t&&n&&i&&a))return null;const r={x:(i.x+a.x)/2,y:(i.y+a.y)/2,z:(i.z+a.z)/2},o={x:n.x,y:n.y,z:n.z},c=Ce,l=Math.abs(s[2])||Se,h=c*Se/l,d=Math.min(t.visibility||.5,n.visibility||.5,i.visibility||.5,a.visibility||.5);return{x:o.x,y:o.y,z:o.z+h,confidence:d,eyeCenter:r,noseTip:{x:t.x,y:t.y,z:t.z}}}catch(n){return console.error("[ANATOMY] Sellion offset calculation failed:",n),null}}(e,this.cameraIntrinsics,n.tvec),a=function(e,t){try{const s=e[50],n=e[280],i=e[172],a=e[398];if(!(s&&n&&i&&a))return null;const r=Math.abs(n.x-s.x)*t,o=Math.abs(a.x-i.x)*t,c=(r+o)/2,l=c*Le;return{width:l,scale:l/ke,faceWidth:c,confidence:Math.min(s.visibility||.5,n.visibility||.5,i.visibility||.5,a.visibility||.5),measurements:{cheekWidth:r,jawWidth:o,imageWidth:t}}}catch(s){return console.error("[ANATOMY] Temple width calculation failed:",s),null}}(e,this.video.videoWidth),r=je(e);if(!i||!a)return this._handleTrackingLoss();const o=Oe(t,{roll:this._computeHeadRoll(e)}),c=500/Math.abs(n.tvec[2]),l=c*a.scale*.92,h=this._calculateLandmarkConfidence(e);let d=Math.min(s.confidence||.9,i.confidence,a.confidence,r.confidence||1,h);o.confidence&&(d=Math.min(d,o.confidence)),this.currentTransform={rvec:n.rvec,tvec:n.tvec,scale:{x:l,y:c,z:c},sellionOffset:i,templeAngle:o.angle,templeAngleData:o,faceProfile:r,confidence:d,effectiveConfidence:d*("CALIBRATED"===this.calibrationState?1:.6),calibrationState:this.calibrationState,trackingState:"TRACKING",hasEarDetection:!!t,frameCount:this.frameCount,enhancedTracking:!1},this.trackingState="TRACKING",this._notifyCallbacks()}_attemptCalibration(e){var t,s,n,i;const a=this.calibrator.estimateFocalLength(e,this.video.videoWidth);if(a){this.calibrator.addSample(a);const e=this.calibrator.getCalibratedFocalLength();if(e){const n=this.video.videoWidth,i=this.video.videoHeight;this.profileMgr.save(this.deviceId,e,n,i),this.cameraIntrinsics={focalLength:e,cx:n/2,cy:i/2,width:n,height:i},this.calibrationState="CALIBRATED",this.poseEstimator.setCameraIntrinsics(this.cameraIntrinsics),console.log(`[CALIB] ✅ Calibrated: ${e.toFixed(1)}px`),null==(s=(t=this.callbacks).onCalibrated)||s.call(t)}else null==(i=(n=this.callbacks).onCalibrationProgress)||i.call(n,this.calibrator.samples.length,this.calibrator.maxSamples)}}_estimateHeadPose(e){if(!this.poseEstimator)return null;try{return this.poseEstimator.estimate(e,{width:this.video.videoWidth,height:this.video.videoHeight,intrinsics:this.cameraIntrinsics})}catch(t){return console.error("[POSE] Estimation failed:",t),null}}_computeHeadRoll(e){const t=e[133],s=e[362];return t&&s?Math.atan2(s.y-t.y,s.x-t.x):0}_validateLandmarks(e){if([1,152,263,33,291,61,468,473].some(t=>!e[t]||e[t].presence<.65))return!1;const t=e[133],s=e[362],n=e[1];if(!t||!s||!n)return!1;const i=Math.hypot(t.x-s.x,t.y-s.y);return!(Math.abs((n.x-(t.x+s.x)/2)/i)>.35)}_calculateLandmarkConfidence(e){return Math.min(...[1,152,263,33,291,61,468,473].map(t=>{var s;return(null==(s=e[t])?void 0:s.presence)||0}))}_handleTrackingLoss(){var e,t,s,n;"LOST"!==this.trackingState&&(console.log("[TRACKER] Tracking lost"),this.trackingState="LOST",this.lossStartTime=Date.now(),this.poseFilter.reset(),null==(t=(e=this.callbacks).onTrackingStateChange)||t.call(e,"LOST")),this.currentTransform=null,null==(n=(s=this.callbacks).onConfidenceUpdate)||n.call(s,0)}_notifyCallbacks(){var e,t,s,n,i,a;null==(t=(e=this.callbacks).onConfidenceUpdate)||t.call(e,this.currentTransform.effectiveConfidence),null==(n=(s=this.callbacks).onEarDetection)||n.call(s,this.currentTransform.hasEarDetection),null==(a=(i=this.callbacks).onTrackingStateChange)||a.call(i,this.trackingState)}destroy(){console.log("[TRACKER] Destroying..."),this.faceMesh&&this.faceMesh.close(),this.holistic&&this.holistic.close(),this.poseFilter&&this.poseFilter.reset(),this.trackingState="DESTROYED"}}function qe(e,t){if(t===s)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),e;if(t===n||t===i){let s=e.getIndex();if(null===s){const t=[],n=e.getAttribute("position");if(void 0===n)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<n.count;e++)t.push(e);e.setIndex(t),s=e.getIndex()}const i=s.count-2,a=[];if(t===n)for(let e=1;e<=i;e++)a.push(s.getX(0)),a.push(s.getX(e)),a.push(s.getX(e+1));else for(let e=0;e<i;e++)e%2==0?(a.push(s.getX(e)),a.push(s.getX(e+1)),a.push(s.getX(e+2))):(a.push(s.getX(e+2)),a.push(s.getX(e+1)),a.push(s.getX(e)));a.length/3!==i&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const r=e.clone();return r.setIndex(a),r.clearGroups(),r}return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",t),e}class Xe extends a{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(e){return new et(e)}),this.register(function(e){return new ct(e)}),this.register(function(e){return new lt(e)}),this.register(function(e){return new ht(e)}),this.register(function(e){return new st(e)}),this.register(function(e){return new nt(e)}),this.register(function(e){return new it(e)}),this.register(function(e){return new at(e)}),this.register(function(e){return new Ze(e)}),this.register(function(e){return new rt(e)}),this.register(function(e){return new tt(e)}),this.register(function(e){return new ot(e)}),this.register(function(e){return new Je(e)}),this.register(function(e){return new dt(e)}),this.register(function(e){return new ut(e)})}load(e,t,s,n){const i=this;let a;a=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:r.extractUrlBase(e),this.manager.itemStart(e);const c=function(t){n?n(t):console.error(t),i.manager.itemError(e),i.manager.itemEnd(e)},l=new o(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.setRequestHeader(this.requestHeader),l.setWithCredentials(this.withCredentials),l.load(e,function(s){try{i.parse(s,a,function(s){t(s),i.manager.itemEnd(e)},c)}catch(n){c(n)}},s,c)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s,n){let i;const a={},r={},o=new TextDecoder;if("string"==typeof e)i=JSON.parse(e);else if(e instanceof ArrayBuffer){if(o.decode(new Uint8Array(e,0,4))===mt){try{a[Ye.KHR_BINARY_GLTF]=new gt(e)}catch(l){return void(n&&n(l))}i=JSON.parse(a[Ye.KHR_BINARY_GLTF].content)}else i=JSON.parse(o.decode(e))}else i=e;if(void 0===i.asset||i.asset.version[0]<2)return void(n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const c=new Ut(i,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});c.fileLoader.setRequestHeader(this.requestHeader);for(let h=0;h<this.pluginCallbacks.length;h++){const e=this.pluginCallbacks[h](c);e.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),r[e.name]=e,a[e.name]=!0}if(i.extensionsUsed)for(let h=0;h<i.extensionsUsed.length;++h){const e=i.extensionsUsed[h],t=i.extensionsRequired||[];switch(e){case Ye.KHR_MATERIALS_UNLIT:a[e]=new Qe;break;case Ye.KHR_DRACO_MESH_COMPRESSION:a[e]=new vt(i,this.dracoLoader);break;case Ye.KHR_TEXTURE_TRANSFORM:a[e]=new At;break;case Ye.KHR_MESH_QUANTIZATION:a[e]=new yt;break;default:t.indexOf(e)>=0&&void 0===r[e]&&console.warn('THREE.GLTFLoader: Unknown extension "'+e+'".')}}c.setExtensions(a),c.setPlugins(r),c.parse(s,n)}parseAsync(e,t){const s=this;return new Promise(function(n,i){s.parse(e,t,n,i)})}}function We(){let e={};return{get:function(t){return e[t]},add:function(t,s){e[t]=s},remove:function(t){delete e[t]},removeAll:function(){e={}}}}const Ye={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class Je{constructor(e){this.parser=e,this.name=Ye.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let s=0,n=t.length;s<n;s++){const n=t[s];n.extensions&&n.extensions[this.name]&&void 0!==n.extensions[this.name].light&&e._addNodeRef(this.cache,n.extensions[this.name].light)}}_loadLight(e){const t=this.parser,s="light:"+e;let n=t.cache.get(s);if(n)return n;const i=t.json,a=((i.extensions&&i.extensions[this.name]||{}).lights||[])[e];let r;const o=new h(16777215);void 0!==a.color&&o.setRGB(a.color[0],a.color[1],a.color[2],d);const c=void 0!==a.range?a.range:0;switch(a.type){case"directional":r=new p(o),r.target.position.set(0,0,-1),r.add(r.target);break;case"point":r=new f(o),r.distance=c;break;case"spot":r=new m(o),r.distance=c,a.spot=a.spot||{},a.spot.innerConeAngle=void 0!==a.spot.innerConeAngle?a.spot.innerConeAngle:0,a.spot.outerConeAngle=void 0!==a.spot.outerConeAngle?a.spot.outerConeAngle:Math.PI/4,r.angle=a.spot.outerConeAngle,r.penumbra=1-a.spot.innerConeAngle/a.spot.outerConeAngle,r.target.position.set(0,0,-1),r.add(r.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+a.type)}return r.position.set(0,0,0),r.decay=2,Dt(r,a),void 0!==a.intensity&&(r.intensity=a.intensity),r.name=t.createUniqueName(a.name||"light_"+e),n=Promise.resolve(r),t.cache.add(s,n),n}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){const t=this,s=this.parser,n=s.json.nodes[e],i=(n.extensions&&n.extensions[this.name]||{}).light;return void 0===i?null:this._loadLight(i).then(function(e){return s._getNodeRef(t.cache,i,e)})}}class Qe{constructor(){this.name=Ye.KHR_MATERIALS_UNLIT}getMaterialType(){return z}extendParams(e,t,s){const n=[];e.color=new h(1,1,1),e.opacity=1;const i=t.pbrMetallicRoughness;if(i){if(Array.isArray(i.baseColorFactor)){const t=i.baseColorFactor;e.color.setRGB(t[0],t[1],t[2],d),e.opacity=t[3]}void 0!==i.baseColorTexture&&n.push(s.assignTexture(e,"map",i.baseColorTexture,u))}return Promise.all(n)}}class Ze{constructor(e){this.parser=e,this.name=Ye.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=s.extensions[this.name].emissiveStrength;return void 0!==n&&(t.emissiveIntensity=n),Promise.resolve()}}class et{constructor(e){this.parser=e,this.name=Ye.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?c:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],a=n.extensions[this.name];if(void 0!==a.clearcoatFactor&&(t.clearcoat=a.clearcoatFactor),void 0!==a.clearcoatTexture&&i.push(s.assignTexture(t,"clearcoatMap",a.clearcoatTexture)),void 0!==a.clearcoatRoughnessFactor&&(t.clearcoatRoughness=a.clearcoatRoughnessFactor),void 0!==a.clearcoatRoughnessTexture&&i.push(s.assignTexture(t,"clearcoatRoughnessMap",a.clearcoatRoughnessTexture)),void 0!==a.clearcoatNormalTexture&&(i.push(s.assignTexture(t,"clearcoatNormalMap",a.clearcoatNormalTexture)),void 0!==a.clearcoatNormalTexture.scale)){const e=a.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new l(e,e)}return Promise.all(i)}}class tt{constructor(e){this.parser=e,this.name=Ye.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?c:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],a=n.extensions[this.name];return void 0!==a.iridescenceFactor&&(t.iridescence=a.iridescenceFactor),void 0!==a.iridescenceTexture&&i.push(s.assignTexture(t,"iridescenceMap",a.iridescenceTexture)),void 0!==a.iridescenceIor&&(t.iridescenceIOR=a.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==a.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=a.iridescenceThicknessMinimum),void 0!==a.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=a.iridescenceThicknessMaximum),void 0!==a.iridescenceThicknessTexture&&i.push(s.assignTexture(t,"iridescenceThicknessMap",a.iridescenceThicknessTexture)),Promise.all(i)}}class st{constructor(e){this.parser=e,this.name=Ye.KHR_MATERIALS_SHEEN}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?c:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[];t.sheenColor=new h(0,0,0),t.sheenRoughness=0,t.sheen=1;const a=n.extensions[this.name];if(void 0!==a.sheenColorFactor){const e=a.sheenColorFactor;t.sheenColor.setRGB(e[0],e[1],e[2],d)}return void 0!==a.sheenRoughnessFactor&&(t.sheenRoughness=a.sheenRoughnessFactor),void 0!==a.sheenColorTexture&&i.push(s.assignTexture(t,"sheenColorMap",a.sheenColorTexture,u)),void 0!==a.sheenRoughnessTexture&&i.push(s.assignTexture(t,"sheenRoughnessMap",a.sheenRoughnessTexture)),Promise.all(i)}}class nt{constructor(e){this.parser=e,this.name=Ye.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?c:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],a=n.extensions[this.name];return void 0!==a.transmissionFactor&&(t.transmission=a.transmissionFactor),void 0!==a.transmissionTexture&&i.push(s.assignTexture(t,"transmissionMap",a.transmissionTexture)),Promise.all(i)}}class it{constructor(e){this.parser=e,this.name=Ye.KHR_MATERIALS_VOLUME}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?c:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],a=n.extensions[this.name];t.thickness=void 0!==a.thicknessFactor?a.thicknessFactor:0,void 0!==a.thicknessTexture&&i.push(s.assignTexture(t,"thicknessMap",a.thicknessTexture)),t.attenuationDistance=a.attenuationDistance||1/0;const r=a.attenuationColor||[1,1,1];return t.attenuationColor=(new h).setRGB(r[0],r[1],r[2],d),Promise.all(i)}}class at{constructor(e){this.parser=e,this.name=Ye.KHR_MATERIALS_IOR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?c:null}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=s.extensions[this.name];return t.ior=void 0!==n.ior?n.ior:1.5,Promise.resolve()}}class rt{constructor(e){this.parser=e,this.name=Ye.KHR_MATERIALS_SPECULAR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?c:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],a=n.extensions[this.name];t.specularIntensity=void 0!==a.specularFactor?a.specularFactor:1,void 0!==a.specularTexture&&i.push(s.assignTexture(t,"specularIntensityMap",a.specularTexture));const r=a.specularColorFactor||[1,1,1];return t.specularColor=(new h).setRGB(r[0],r[1],r[2],d),void 0!==a.specularColorTexture&&i.push(s.assignTexture(t,"specularColorMap",a.specularColorTexture,u)),Promise.all(i)}}class ot{constructor(e){this.parser=e,this.name=Ye.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?c:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],a=n.extensions[this.name];return void 0!==a.anisotropyStrength&&(t.anisotropy=a.anisotropyStrength),void 0!==a.anisotropyRotation&&(t.anisotropyRotation=a.anisotropyRotation),void 0!==a.anisotropyTexture&&i.push(s.assignTexture(t,"anisotropyMap",a.anisotropyTexture)),Promise.all(i)}}class ct{constructor(e){this.parser=e,this.name=Ye.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,s=t.json,n=s.textures[e];if(!n.extensions||!n.extensions[this.name])return null;const i=n.extensions[this.name],a=t.options.ktx2Loader;if(!a){if(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,i.source,a)}}class lt{constructor(e){this.parser=e,this.name=Ye.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,n=s.json,i=n.textures[e];if(!i.extensions||!i.extensions[t])return null;const a=i.extensions[t],r=n.images[a.source];let o=s.textureLoader;if(r.uri){const e=s.options.manager.getHandler(r.uri);null!==e&&(o=e)}return this.detectSupport().then(function(i){if(i)return s.loadTextureImage(e,a.source,o);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return s.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}})),this.isSupported}}class ht{constructor(e){this.parser=e,this.name=Ye.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,n=s.json,i=n.textures[e];if(!i.extensions||!i.extensions[t])return null;const a=i.extensions[t],r=n.images[a.source];let o=s.textureLoader;if(r.uri){const e=s.options.manager.getHandler(r.uri);null!==e&&(o=e)}return this.detectSupport().then(function(i){if(i)return s.loadTextureImage(e,a.source,o);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return s.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(1===t.height)}})),this.isSupported}}class dt{constructor(e){this.name=Ye.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,s=t.bufferViews[e];if(s.extensions&&s.extensions[this.name]){const e=s.extensions[this.name],n=this.parser.getDependency("buffer",e.buffer),i=this.parser.options.meshoptDecoder;if(!i||!i.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return n.then(function(t){const s=e.byteOffset||0,n=e.byteLength||0,a=e.count,r=e.byteStride,o=new Uint8Array(t,s,n);return i.decodeGltfBufferAsync?i.decodeGltfBufferAsync(a,r,o,e.mode,e.filter).then(function(e){return e.buffer}):i.ready.then(function(){const t=new ArrayBuffer(a*r);return i.decodeGltfBuffer(new Uint8Array(t),a,r,o,e.mode,e.filter),t})})}return null}}class ut{constructor(e){this.name=Ye.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,s=t.nodes[e];if(!s.extensions||!s.extensions[this.name]||void 0===s.mesh)return null;const n=t.meshes[s.mesh];for(const o of n.primitives)if(o.mode!==wt.TRIANGLES&&o.mode!==wt.TRIANGLE_STRIP&&o.mode!==wt.TRIANGLE_FAN&&void 0!==o.mode)return null;const i=s.extensions[this.name].attributes,a=[],r={};for(const o in i)a.push(this.parser.getDependency("accessor",i[o]).then(e=>(r[o]=e,r[o])));return a.length<1?null:(a.push(this.parser.createNodeMesh(e)),Promise.all(a).then(e=>{const t=e.pop(),s=t.isGroup?t.children:[t],n=e[0].count,i=[];for(const a of s){const e=new g,t=new v,s=new y,o=new v(1,1,1),c=new A(a.geometry,a.material,n);for(let i=0;i<n;i++)r.TRANSLATION&&t.fromBufferAttribute(r.TRANSLATION,i),r.ROTATION&&s.fromBufferAttribute(r.ROTATION,i),r.SCALE&&o.fromBufferAttribute(r.SCALE,i),c.setMatrixAt(i,e.compose(t,s,o));for(const n in r)if("_COLOR_0"===n){const e=r[n];c.instanceColor=new E(e.array,e.itemSize,e.normalized)}else"TRANSLATION"!==n&&"ROTATION"!==n&&"SCALE"!==n&&a.geometry.setAttribute(n,r[n]);T.prototype.copy.call(c,a),this.parser.assignFinalMaterial(c),i.push(c)}return t.isGroup?(t.clear(),t.add(...i),t):i[0]}))}}const mt="glTF",ft=1313821514,pt=5130562;class gt{constructor(e){this.name=Ye.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12),s=new TextDecoder;if(this.header={magic:s.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==mt)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const n=this.header.length-12,i=new DataView(e,12);let a=0;for(;a<n;){const t=i.getUint32(a,!0);a+=4;const n=i.getUint32(a,!0);if(a+=4,n===ft){const n=new Uint8Array(e,12+a,t);this.content=s.decode(n)}else if(n===pt){const s=12+a;this.body=e.slice(s,s+t)}a+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class vt{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=Ye.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const s=this.json,n=this.dracoLoader,i=e.extensions[this.name].bufferView,a=e.extensions[this.name].attributes,r={},o={},c={};for(const l in a){const e=Mt[l]||l.toLowerCase();r[e]=a[l]}for(const l in e.attributes){const t=Mt[l]||l.toLowerCase();if(void 0!==a[l]){const n=s.accessors[e.attributes[l]],i=Rt[n.componentType];c[t]=i.name,o[t]=!0===n.normalized}}return t.getDependency("bufferView",i).then(function(e){return new Promise(function(t){n.decodeDracoFile(e,function(e){for(const t in e.attributes){const s=e.attributes[t],n=o[t];void 0!==n&&(s.normalized=n)}t(e)},r,c)})})}}class At{constructor(){this.name=Ye.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&t.texCoord!==e.channel||void 0!==t.offset||void 0!==t.rotation||void 0!==t.scale?(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0,e):e}}class yt{constructor(){this.name=Ye.KHR_MESH_QUANTIZATION}}class Et extends de{constructor(e,t,s,n){super(e,t,s,n)}copySampleValue_(e){const t=this.resultBuffer,s=this.sampleValues,n=this.valueSize,i=e*n*3+n;for(let a=0;a!==n;a++)t[a]=s[i+a];return t}interpolate_(e,t,s,n){const i=this.resultBuffer,a=this.sampleValues,r=this.valueSize,o=2*r,c=3*r,l=n-t,h=(s-t)/l,d=h*h,u=d*h,m=e*c,f=m-c,p=-2*u+3*d,g=u-d,v=1-p,A=g-d+h;for(let y=0;y!==r;y++){const e=a[f+y+r],t=a[f+y+o]*l,s=a[m+y+r],n=a[m+y]*l;i[y]=v*e+A*t+p*s+g*n}return i}}const Tt=new y;class _t extends Et{interpolate_(e,t,s,n){const i=super.interpolate_(e,t,s,n);return Tt.fromArray(i).normalize().toArray(i),i}}const wt={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},Rt={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},xt={9728:L,9729:C,9984:S,9985:M,9986:b,9987:I},It={33071:P,33648:F,10497:k},bt={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Mt={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},St={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Ct={CUBICSPLINE:void 0,LINEAR:ne,STEP:se},Lt="OPAQUE",kt="MASK",Ft="BLEND";function Pt(e){return void 0===e.DefaultMaterial&&(e.DefaultMaterial=new B({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:he})),e.DefaultMaterial}function Nt(e,t,s){for(const n in s.extensions)void 0===e[n]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[n]=s.extensions[n])}function Dt(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function Ot(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let s=0,n=t.weights.length;s<n;s++)e.morphTargetInfluences[s]=t.weights[s];if(t.extras&&Array.isArray(t.extras.targetNames)){const s=t.extras.targetNames;if(e.morphTargetInfluences.length===s.length){e.morphTargetDictionary={};for(let t=0,n=s.length;t<n;t++)e.morphTargetDictionary[s[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function Bt(e){let t;const s=e.extensions&&e.extensions[Ye.KHR_DRACO_MESH_COMPRESSION];if(t=s?"draco:"+s.bufferView+":"+s.indices+":"+Ht(s.attributes):e.indices+":"+Ht(e.attributes)+":"+e.mode,void 0!==e.targets)for(let n=0,i=e.targets.length;n<i;n++)t+=":"+Ht(e.targets[n]);return t}function Ht(e){let t="";const s=Object.keys(e).sort();for(let n=0,i=s.length;n<i;n++)t+=s[n]+":"+e[s[n]]+";";return t}function zt(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}const jt=new g;class Ut{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new We,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let s=!1,n=!1,i=-1;"undefined"!=typeof navigator&&(s=!0===/^((?!chrome|android).)*safari/i.test(navigator.userAgent),n=navigator.userAgent.indexOf("Firefox")>-1,i=n?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),"undefined"==typeof createImageBitmap||s||n&&i<98?this.textureLoader=new _(this.options.manager):this.textureLoader=new w(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new o(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const s=this,n=this.json,i=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(e){return e._markDefs&&e._markDefs()}),Promise.all(this._invokeAll(function(e){return e.beforeRoot&&e.beforeRoot()})).then(function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera")])}).then(function(t){const a={scene:t[0][n.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:n.asset,parser:s,userData:{}};return Nt(i,a,n),Dt(a,n),Promise.all(s._invokeAll(function(e){return e.afterRoot&&e.afterRoot(a)})).then(function(){e(a)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[];for(let n=0,i=t.length;n<i;n++){const s=t[n].joints;for(let t=0,n=s.length;t<n;t++)e[s[t]].isBone=!0}for(let n=0,i=e.length;n<i;n++){const t=e[n];void 0!==t.mesh&&(this._addNodeRef(this.meshCache,t.mesh),void 0!==t.skin&&(s[t.mesh].isSkinnedMesh=!0)),void 0!==t.camera&&this._addNodeRef(this.cameraCache,t.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,s){if(e.refs[t]<=1)return s;const n=s.clone(),i=(e,t)=>{const s=this.associations.get(e);null!=s&&this.associations.set(t,s);for(const[n,a]of e.children.entries())i(a,t.children[n])};return i(s,n),n.name+="_instance_"+e.uses[t]++,n}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let s=0;s<t.length;s++){const n=e(t[s]);if(n)return n}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const s=[];for(let n=0;n<t.length;n++){const i=e(t[n]);i&&s.push(i)}return s}getDependency(e,t){const s=e+":"+t;let n=this.cache.get(s);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this._invokeOne(function(e){return e.loadNode&&e.loadNode(t)});break;case"mesh":n=this._invokeOne(function(e){return e.loadMesh&&e.loadMesh(t)});break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne(function(e){return e.loadBufferView&&e.loadBufferView(t)});break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne(function(e){return e.loadMaterial&&e.loadMaterial(t)});break;case"texture":n=this._invokeOne(function(e){return e.loadTexture&&e.loadTexture(t)});break;case"skin":n=this.loadSkin(t);break;case"animation":n=this._invokeOne(function(e){return e.loadAnimation&&e.loadAnimation(t)});break;case"camera":n=this.loadCamera(t);break;default:if(n=this._invokeOne(function(s){return s!=this&&s.getDependency&&s.getDependency(e,t)}),!n)throw new Error("Unknown type: "+e)}this.cache.add(s,n)}return n}getDependencies(e){let t=this.cache.get(e);if(!t){const s=this,n=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(n.map(function(t,n){return s.getDependency(e,n)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],s=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[Ye.KHR_BINARY_GLTF].body);const n=this.options;return new Promise(function(e,i){s.load(r.resolveURL(t.uri,n.path),e,void 0,function(){i(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(e){const s=t.byteLength||0,n=t.byteOffset||0;return e.slice(n,n+s)})}loadAccessor(e){const t=this,s=this.json,n=this.json.accessors[e];if(void 0===n.bufferView&&void 0===n.sparse){const e=bt[n.type],t=Rt[n.componentType],s=!0===n.normalized,i=new t(n.count*e);return Promise.resolve(new R(i,e,s))}const i=[];return void 0!==n.bufferView?i.push(this.getDependency("bufferView",n.bufferView)):i.push(null),void 0!==n.sparse&&(i.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),i.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(i).then(function(e){const i=e[0],a=bt[n.type],r=Rt[n.componentType],o=r.BYTES_PER_ELEMENT,c=o*a,l=n.byteOffset||0,h=void 0!==n.bufferView?s.bufferViews[n.bufferView].byteStride:void 0,d=!0===n.normalized;let u,m;if(h&&h!==c){const e=Math.floor(l/h),s="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+e+":"+n.count;let c=t.cache.get(s);c||(u=new r(i,e*h,n.count*h/o),c=new x(u,h/o),t.cache.add(s,c)),m=new ie(c,a,l%h/o,d)}else u=null===i?new r(n.count*a):new r(i,l,n.count*a),m=new R(u,a,d);if(void 0!==n.sparse){const t=bt.SCALAR,s=Rt[n.sparse.indices.componentType],o=n.sparse.indices.byteOffset||0,c=n.sparse.values.byteOffset||0,l=new s(e[1],o,n.sparse.count*t),h=new r(e[2],c,n.sparse.count*a);null!==i&&(m=new R(m.array.slice(),m.itemSize,m.normalized));for(let e=0,n=l.length;e<n;e++){const t=l[e];if(m.setX(t,h[e*a]),a>=2&&m.setY(t,h[e*a+1]),a>=3&&m.setZ(t,h[e*a+2]),a>=4&&m.setW(t,h[e*a+3]),a>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return m})}loadTexture(e){const t=this.json,s=this.options,n=t.textures[e].source,i=t.images[n];let a=this.textureLoader;if(i.uri){const e=s.manager.getHandler(i.uri);null!==e&&(a=e)}return this.loadTextureImage(e,n,a)}loadTextureImage(e,t,s){const n=this,i=this.json,a=i.textures[e],r=i.images[t],o=(r.uri||r.bufferView)+":"+a.sampler;if(this.textureCache[o])return this.textureCache[o];const c=this.loadImageSource(t,s).then(function(t){t.flipY=!1,t.name=a.name||r.name||"",""===t.name&&"string"==typeof r.uri&&!1===r.uri.startsWith("data:image/")&&(t.name=r.uri);const s=(i.samplers||{})[a.sampler]||{};return t.magFilter=xt[s.magFilter]||C,t.minFilter=xt[s.minFilter]||I,t.wrapS=It[s.wrapS]||k,t.wrapT=It[s.wrapT]||k,n.associations.set(t,{textures:e}),t}).catch(function(){return null});return this.textureCache[o]=c,c}loadImageSource(e,t){const s=this,n=this.json,i=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then(e=>e.clone());const a=n.images[e],o=self.URL||self.webkitURL;let c=a.uri||"",l=!1;if(void 0!==a.bufferView)c=s.getDependency("bufferView",a.bufferView).then(function(e){l=!0;const t=new Blob([e],{type:a.mimeType});return c=o.createObjectURL(t),c});else if(void 0===a.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const h=Promise.resolve(c).then(function(e){return new Promise(function(s,n){let a=s;!0===t.isImageBitmapLoader&&(a=function(e){const t=new ae(e);t.needsUpdate=!0,s(t)}),t.load(r.resolveURL(e,i.path),a,void 0,n)})}).then(function(e){var t;return!0===l&&o.revokeObjectURL(c),e.userData.mimeType=a.mimeType||((t=a.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":"image/png"),e}).catch(function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",c),e});return this.sourceCache[e]=h,h}assignTexture(e,t,s,n){const i=this;return this.getDependency("texture",s.index).then(function(a){if(!a)return null;if(void 0!==s.texCoord&&s.texCoord>0&&((a=a.clone()).channel=s.texCoord),i.extensions[Ye.KHR_TEXTURE_TRANSFORM]){const e=void 0!==s.extensions?s.extensions[Ye.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=i.associations.get(a);a=i.extensions[Ye.KHR_TEXTURE_TRANSFORM].extendTexture(a,e),i.associations.set(a,t)}}return void 0!==n&&(a.colorSpace=n),e[t]=a,a})}assignFinalMaterial(e){const t=e.geometry;let s=e.material;const n=void 0===t.attributes.tangent,i=void 0!==t.attributes.color,a=void 0===t.attributes.normal;if(e.isPoints){const e="PointsMaterial:"+s.uuid;let t=this.cache.get(e);t||(t=new N,D.prototype.copy.call(t,s),t.color.copy(s.color),t.map=s.map,t.sizeAttenuation=!1,this.cache.add(e,t)),s=t}else if(e.isLine){const e="LineBasicMaterial:"+s.uuid;let t=this.cache.get(e);t||(t=new O,D.prototype.copy.call(t,s),t.color.copy(s.color),t.map=s.map,this.cache.add(e,t)),s=t}if(n||i||a){let e="ClonedMaterial:"+s.uuid+":";n&&(e+="derivative-tangents:"),i&&(e+="vertex-colors:"),a&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=s.clone(),i&&(t.vertexColors=!0),a&&(t.flatShading=!0),n&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(s))),s=t}e.material=s}getMaterialType(){return B}loadMaterial(e){const t=this,s=this.json,n=this.extensions,i=s.materials[e];let a;const r={},o=[];if((i.extensions||{})[Ye.KHR_MATERIALS_UNLIT]){const e=n[Ye.KHR_MATERIALS_UNLIT];a=e.getMaterialType(),o.push(e.extendParams(r,i,t))}else{const s=i.pbrMetallicRoughness||{};if(r.color=new h(1,1,1),r.opacity=1,Array.isArray(s.baseColorFactor)){const e=s.baseColorFactor;r.color.setRGB(e[0],e[1],e[2],d),r.opacity=e[3]}void 0!==s.baseColorTexture&&o.push(t.assignTexture(r,"map",s.baseColorTexture,u)),r.metalness=void 0!==s.metallicFactor?s.metallicFactor:1,r.roughness=void 0!==s.roughnessFactor?s.roughnessFactor:1,void 0!==s.metallicRoughnessTexture&&(o.push(t.assignTexture(r,"metalnessMap",s.metallicRoughnessTexture)),o.push(t.assignTexture(r,"roughnessMap",s.metallicRoughnessTexture))),a=this._invokeOne(function(t){return t.getMaterialType&&t.getMaterialType(e)}),o.push(Promise.all(this._invokeAll(function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,r)})))}!0===i.doubleSided&&(r.side=H);const c=i.alphaMode||Lt;if(c===Ft?(r.transparent=!0,r.depthWrite=!1):(r.transparent=!1,c===kt&&(r.alphaTest=void 0!==i.alphaCutoff?i.alphaCutoff:.5)),void 0!==i.normalTexture&&a!==z&&(o.push(t.assignTexture(r,"normalMap",i.normalTexture)),r.normalScale=new l(1,1),void 0!==i.normalTexture.scale)){const e=i.normalTexture.scale;r.normalScale.set(e,e)}if(void 0!==i.occlusionTexture&&a!==z&&(o.push(t.assignTexture(r,"aoMap",i.occlusionTexture)),void 0!==i.occlusionTexture.strength&&(r.aoMapIntensity=i.occlusionTexture.strength)),void 0!==i.emissiveFactor&&a!==z){const e=i.emissiveFactor;r.emissive=(new h).setRGB(e[0],e[1],e[2],d)}return void 0!==i.emissiveTexture&&a!==z&&o.push(t.assignTexture(r,"emissiveMap",i.emissiveTexture,u)),Promise.all(o).then(function(){const s=new a(r);return i.name&&(s.name=i.name),Dt(s,i),t.associations.set(s,{materials:e}),i.extensions&&Nt(n,s,i),s})}createUniqueName(e){const t=j.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,s=this.extensions,n=this.primitiveCache;function i(e){return s[Ye.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then(function(s){return Gt(s,e,t)})}const a=[];for(let r=0,o=e.length;r<o;r++){const s=e[r],o=Bt(s),c=n[o];if(c)a.push(c.promise);else{let e;e=s.extensions&&s.extensions[Ye.KHR_DRACO_MESH_COMPRESSION]?i(s):Gt(new U,s,t),n[o]={primitive:s,promise:e},a.push(e)}}return Promise.all(a)}loadMesh(e){const t=this,s=this.json,a=this.extensions,r=s.meshes[e],o=r.primitives,c=[];for(let n=0,i=o.length;n<i;n++){const e=void 0===o[n].material?Pt(this.cache):this.getDependency("material",o[n].material);c.push(e)}return c.push(t.loadGeometries(o)),Promise.all(c).then(function(s){const c=s.slice(0,s.length-1),l=s[s.length-1],h=[];for(let u=0,m=l.length;u<m;u++){const s=l[u],d=o[u];let m;const f=c[u];if(d.mode===wt.TRIANGLES||d.mode===wt.TRIANGLE_STRIP||d.mode===wt.TRIANGLE_FAN||void 0===d.mode)m=!0===r.isSkinnedMesh?new G(s,f):new K(s,f),!0===m.isSkinnedMesh&&m.normalizeSkinWeights(),d.mode===wt.TRIANGLE_STRIP?m.geometry=qe(m.geometry,i):d.mode===wt.TRIANGLE_FAN&&(m.geometry=qe(m.geometry,n));else if(d.mode===wt.LINES)m=new V(s,f);else if(d.mode===wt.LINE_STRIP)m=new $(s,f);else if(d.mode===wt.LINE_LOOP)m=new q(s,f);else{if(d.mode!==wt.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+d.mode);m=new X(s,f)}Object.keys(m.geometry.morphAttributes).length>0&&Ot(m,r),m.name=t.createUniqueName(r.name||"mesh_"+e),Dt(m,r),d.extensions&&Nt(a,m,d),t.assignFinalMaterial(m),h.push(m)}for(let n=0,i=h.length;n<i;n++)t.associations.set(h[n],{meshes:e,primitives:n});if(1===h.length)return r.extensions&&Nt(a,h[0],r),h[0];const d=new W;r.extensions&&Nt(a,d,r),t.associations.set(d,{meshes:e});for(let e=0,t=h.length;e<t;e++)d.add(h[e]);return d})}loadCamera(e){let t;const s=this.json.cameras[e],n=s[s.type];if(n)return"perspective"===s.type?t=new Y(J.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===s.type&&(t=new Q(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),s.name&&(t.name=this.createUniqueName(s.name)),Dt(t,s),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){const t=this.json.skins[e],s=[];for(let n=0,i=t.joints.length;n<i;n++)s.push(this._loadNodeShallow(t.joints[n]));return void 0!==t.inverseBindMatrices?s.push(this.getDependency("accessor",t.inverseBindMatrices)):s.push(null),Promise.all(s).then(function(e){const s=e.pop(),n=e,i=[],a=[];for(let r=0,o=n.length;r<o;r++){const e=n[r];if(e){i.push(e);const t=new g;null!==s&&t.fromArray(s.array,16*r),a.push(t)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[r])}return new Z(i,a)})}loadAnimation(e){const t=this.json,s=this,n=t.animations[e],i=n.name?n.name:"animation_"+e,a=[],r=[],o=[],c=[],l=[];for(let h=0,d=n.channels.length;h<d;h++){const e=n.channels[h],t=n.samplers[e.sampler],s=e.target,i=s.node,d=void 0!==n.parameters?n.parameters[t.input]:t.input,u=void 0!==n.parameters?n.parameters[t.output]:t.output;void 0!==s.node&&(a.push(this.getDependency("node",i)),r.push(this.getDependency("accessor",d)),o.push(this.getDependency("accessor",u)),c.push(t),l.push(s))}return Promise.all([Promise.all(a),Promise.all(r),Promise.all(o),Promise.all(c),Promise.all(l)]).then(function(e){const t=e[0],n=e[1],a=e[2],r=e[3],o=e[4],c=[];for(let i=0,l=t.length;i<l;i++){const e=t[i],l=n[i],h=a[i],d=r[i],u=o[i];if(void 0===e)continue;e.updateMatrix&&e.updateMatrix();const m=s._createAnimationTracks(e,l,h,d,u);if(m)for(let t=0;t<m.length;t++)c.push(m[t])}return new ee(i,void 0,c)})}createNodeMesh(e){const t=this.json,s=this,n=t.nodes[e];return void 0===n.mesh?null:s.getDependency("mesh",n.mesh).then(function(e){const t=s._getNodeRef(s.meshCache,n.mesh,e);return void 0!==n.weights&&t.traverse(function(e){if(e.isMesh)for(let t=0,s=n.weights.length;t<s;t++)e.morphTargetInfluences[t]=n.weights[t]}),t})}loadNode(e){const t=this,s=this.json.nodes[e],n=t._loadNodeShallow(e),i=[],a=s.children||[];for(let o=0,c=a.length;o<c;o++)i.push(t.getDependency("node",a[o]));const r=void 0===s.skin?Promise.resolve(null):t.getDependency("skin",s.skin);return Promise.all([n,Promise.all(i),r]).then(function(e){const t=e[0],s=e[1],n=e[2];null!==n&&t.traverse(function(e){e.isSkinnedMesh&&e.bind(n,jt)});for(let i=0,a=s.length;i<a;i++)t.add(s[i]);return t})}_loadNodeShallow(e){const t=this.json,s=this.extensions,n=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];const i=t.nodes[e],a=i.name?n.createUniqueName(i.name):"",r=[],o=n._invokeOne(function(t){return t.createNodeMesh&&t.createNodeMesh(e)});return o&&r.push(o),void 0!==i.camera&&r.push(n.getDependency("camera",i.camera).then(function(e){return n._getNodeRef(n.cameraCache,i.camera,e)})),n._invokeAll(function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)}).forEach(function(e){r.push(e)}),this.nodeCache[e]=Promise.all(r).then(function(t){let r;if(r=!0===i.isBone?new te:t.length>1?new W:1===t.length?t[0]:new T,r!==t[0])for(let e=0,s=t.length;e<s;e++)r.add(t[e]);if(i.name&&(r.userData.name=i.name,r.name=a),Dt(r,i),i.extensions&&Nt(s,r,i),void 0!==i.matrix){const e=new g;e.fromArray(i.matrix),r.applyMatrix4(e)}else void 0!==i.translation&&r.position.fromArray(i.translation),void 0!==i.rotation&&r.quaternion.fromArray(i.rotation),void 0!==i.scale&&r.scale.fromArray(i.scale);return n.associations.has(r)||n.associations.set(r,{}),n.associations.get(r).nodes=e,r}),this.nodeCache[e]}loadScene(e){const t=this.extensions,s=this.json.scenes[e],n=this,i=new W;s.name&&(i.name=n.createUniqueName(s.name)),Dt(i,s),s.extensions&&Nt(t,i,s);const a=s.nodes||[],r=[];for(let o=0,c=a.length;o<c;o++)r.push(n.getDependency("node",a[o]));return Promise.all(r).then(function(e){for(let t=0,s=e.length;t<s;t++)i.add(e[t]);return n.associations=(e=>{const t=new Map;for(const[s,i]of n.associations)(s instanceof D||s instanceof ae)&&t.set(s,i);return e.traverse(e=>{const s=n.associations.get(e);null!=s&&t.set(e,s)}),t})(i),i})}_createAnimationTracks(e,t,s,n,i){const a=[],r=e.name?e.name:e.uuid,o=[];let c;switch(St[i.path]===St.weights?e.traverse(function(e){e.morphTargetInfluences&&o.push(e.name?e.name:e.uuid)}):o.push(r),St[i.path]){case St.weights:c=oe;break;case St.rotation:c=ce;break;case St.position:case St.scale:c=re;break;default:if(1===s.itemSize)c=oe;else c=re}const l=void 0!==n.interpolation?Ct[n.interpolation]:ne,h=this._getArrayFromAccessor(s);for(let d=0,u=o.length;d<u;d++){const e=new c(o[d]+"."+St[i.path],t.array,h,l);"CUBICSPLINE"===n.interpolation&&this._createCubicSplineTrackInterpolant(e),a.push(e)}return a}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const e=zt(t.constructor),s=new Float32Array(t.length);for(let n=0,i=t.length;n<i;n++)s[n]=t[n]*e;t=s}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(e){return new(this instanceof ce?_t:Et)(this.times,this.values,this.getValueSize()/3,e)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function Gt(e,t,s){const n=t.attributes,i=[];function a(t,n){return s.getDependency("accessor",t).then(function(t){e.setAttribute(n,t)})}for(const r in n){const t=Mt[r]||r.toLowerCase();t in e.attributes||i.push(a(n[r],t))}if(void 0!==t.indices&&!e.index){const n=s.getDependency("accessor",t.indices).then(function(t){e.setIndex(t)});i.push(n)}return le.workingColorSpace!==d&&"COLOR_0"in n&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${le.workingColorSpace}" not supported.`),Dt(e,t),function(e,t,s){const n=t.attributes,i=new ue;if(void 0===n.POSITION)return;{const e=s.json.accessors[n.POSITION],t=e.min,a=e.max;if(void 0===t||void 0===a)return void console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(i.set(new v(t[0],t[1],t[2]),new v(a[0],a[1],a[2])),e.normalized){const t=zt(Rt[e.componentType]);i.min.multiplyScalar(t),i.max.multiplyScalar(t)}}const a=t.targets;if(void 0!==a){const e=new v,t=new v;for(let n=0,i=a.length;n<i;n++){const i=a[n];if(void 0!==i.POSITION){const n=s.json.accessors[i.POSITION],a=n.min,r=n.max;if(void 0!==a&&void 0!==r){if(t.setX(Math.max(Math.abs(a[0]),Math.abs(r[0]))),t.setY(Math.max(Math.abs(a[1]),Math.abs(r[1]))),t.setZ(Math.max(Math.abs(a[2]),Math.abs(r[2]))),n.normalized){const e=zt(Rt[n.componentType]);t.multiplyScalar(e)}e.max(t)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}i.expandByVector(e)}e.boundingBox=i;const r=new me;i.getCenter(r.center),r.radius=i.min.distanceTo(i.max)/2,e.boundingSphere=r}(e,t,s),Promise.all(i).then(function(){return void 0!==t.targets?function(e,t,s){let n=!1,i=!1,a=!1;for(let l=0,h=t.length;l<h;l++){const e=t[l];if(void 0!==e.POSITION&&(n=!0),void 0!==e.NORMAL&&(i=!0),void 0!==e.COLOR_0&&(a=!0),n&&i&&a)break}if(!n&&!i&&!a)return Promise.resolve(e);const r=[],o=[],c=[];for(let l=0,h=t.length;l<h;l++){const h=t[l];if(n){const t=void 0!==h.POSITION?s.getDependency("accessor",h.POSITION):e.attributes.position;r.push(t)}if(i){const t=void 0!==h.NORMAL?s.getDependency("accessor",h.NORMAL):e.attributes.normal;o.push(t)}if(a){const t=void 0!==h.COLOR_0?s.getDependency("accessor",h.COLOR_0):e.attributes.color;c.push(t)}}return Promise.all([Promise.all(r),Promise.all(o),Promise.all(c)]).then(function(t){const s=t[0],r=t[1],o=t[2];return n&&(e.morphAttributes.position=s),i&&(e.morphAttributes.normal=r),a&&(e.morphAttributes.color=o),e.morphTargetsRelative=!0,e})}(e,t.targets,s):e})}class Kt{constructor(){this.currentLeftAngle=0,this.currentRightAngle=0,this.targetLeftAngle=0,this.targetRightAngle=0,this.smoothingFactor=.15,this.templeGroups=new Map}updateTempleAngles(e,t,s){try{if(!e)return;this._findTempleGroups(e);const{leftAngle:n,rightAngle:i}=this._calculateTargetAngles(t,s);this.targetLeftAngle=n,this.targetRightAngle=i,this._smoothAngleTransitions(),this._applyTempleAngles()}catch(n){console.error("[TEMPLE] Angle adjustment failed:",n)}}_findTempleGroups(e){this.templeGroups.size>0||(e.traverse(e=>{var t;if(e.isMesh||e.isGroup){const s=(null==(t=e.name)?void 0:t.toLowerCase())||"";(s.includes("temple")||s.includes("ear"))&&(s.includes("left")||e.position.x<0?this.templeGroups.set("left",e):(s.includes("right")||e.position.x>0)&&this.templeGroups.set("right",e))}}),console.log(`[TEMPLE] Found ${this.templeGroups.size} temple groups`))}_calculateTargetAngles(e,t){try{let s=e,n=e;if(t&&t.measurements){const{earSpread:e,normalizedEarSpread:i,headRoll:a}=t.measurements;if(i>.7?(s+=2,n+=2):i<.4&&(s-=2,n-=2),void 0!==a){const e=5*a;s-=e,n+=e}}return s=Math.max(-15,Math.min(25,s)),n=Math.max(-15,Math.min(25,n)),{leftAngle:s,rightAngle:n}}catch(s){return console.error("[TEMPLE] Angle calculation failed:",s),{leftAngle:e,rightAngle:e}}}_smoothAngleTransitions(){this.currentLeftAngle+=(this.targetLeftAngle-this.currentLeftAngle)*this.smoothingFactor,this.currentRightAngle+=(this.targetRightAngle-this.currentRightAngle)*this.smoothingFactor}_applyTempleAngles(){const e=this.templeGroups.get("left"),t=this.templeGroups.get("right");e&&this._applyTempleRotation(e,this.currentLeftAngle,"left"),t&&this._applyTempleRotation(t,this.currentRightAngle,"right")}_applyTempleRotation(e,t,s){try{e.userData.originalRotation||(e.userData.originalRotation=e.rotation.clone());const n=e.userData.originalRotation,i=t*(Math.PI/180);"left"===s?(e.rotation.y=n.y+i,e.rotation.z=n.z+.3*i):(e.rotation.y=n.y-i,e.rotation.z=n.z-.3*i)}catch(n){console.error(`[TEMPLE] Failed to apply ${s} temple rotation:`,n)}}setSmoothingFactor(e){this.smoothingFactor=Math.max(.05,Math.min(.5,e))}reset(){this.currentLeftAngle=0,this.currentRightAngle=0,this.targetLeftAngle=0,this.targetRightAngle=0,this.templeGroups.forEach(e=>{e.userData.originalRotation&&e.rotation.copy(e.userData.originalRotation)}),console.log("[TEMPLE] Temple angles reset")}getCurrentAngles(){return{left:this.currentLeftAngle,right:this.currentRightAngle,target:{left:this.targetLeftAngle,right:this.targetRightAngle}}}animateToAngle(e,t,s=1e3){const n=this.currentLeftAngle,i=this.currentRightAngle,a=performance.now(),r=()=>{const o=performance.now()-a,c=Math.min(o/s,1),l=1-Math.pow(1-c,3);this.currentLeftAngle=n+(e-n)*l,this.currentRightAngle=i+(t-i)*l,this.targetLeftAngle=e,this.targetRightAngle=t,c<1&&requestAnimationFrame(r)};r()}destroy(){this.templeGroups.clear(),console.log("[TEMPLE] Temple adjuster destroyed")}}class Vt{constructor(e){this.canvas=e,this.scene=null,this.camera=null,this.renderer=null,this.glassesModel=null,this.templeAdjuster=null,this.currentFrameId="glasses2",this.isVisible=!1,this.opacity=0,this.targetOpacity=1,this._initializeRenderer(),this._initializeScene(),this._initializeLighting(),this._initializeTempleAdjuster()}_initializeRenderer(){try{let t=null;try{t=this.canvas.getContext("webgl2")||this.canvas.getContext("webgl")}catch(e){console.warn("[RENDERER] Could not get existing context:",e.message)}const s={canvas:this.canvas,alpha:!0,antialias:!0,powerPreference:"high-performance"};t&&(console.log("[RENDERER] Using existing WebGL context"),s.context=t),this.renderer=new fe(s),this.renderer.setSize(this.canvas.width,this.canvas.height),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.renderer.setClearColor(0,0),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=pe,console.log("[RENDERER] Three.js renderer initialized successfully")}catch(t){console.error("[RENDERER] Failed to initialize renderer:",t);try{console.log("[RENDERER] Trying fallback renderer without antialias..."),this.renderer=new fe({canvas:this.canvas,alpha:!0,antialias:!1}),this.renderer.setSize(this.canvas.width,this.canvas.height),this.renderer.setPixelRatio(1),this.renderer.setClearColor(0,0),console.log("[RENDERER] Fallback renderer initialized")}catch(s){throw console.error("[RENDERER] Fallback renderer also failed:",s),new Error("WebGL not supported or canvas context conflict")}}}_initializeScene(){this.scene=new ge;const e=this.canvas.width/this.canvas.height;this.camera=new Y(50,e,1,2e3),this.camera.position.z=500,console.log("[RENDERER] Scene initialized")}_initializeLighting(){const e=new ve(16777215,.6);this.scene.add(e);const t=new p(16777215,.8);t.position.set(100,100,50),t.castShadow=!0,t.shadow.mapSize.width=1024,t.shadow.mapSize.height=1024,this.scene.add(t);const s=new p(16777215,.3);s.position.set(-100,-50,-50),this.scene.add(s),console.log("[RENDERER] Lighting initialized")}_initializeTempleAdjuster(){this.templeAdjuster=new Kt}async loadModel(e){try{console.log(`[RENDERER] Loading frame model: ${e}`),this.glassesModel&&(this.scene.remove(this.glassesModel),this._disposeModel(this.glassesModel)),this.glassesModel=await this._loadModel(e),this.glassesModel&&(this.scene.add(this.glassesModel),this.currentFrameId=e,this.isVisible=!0,console.log(`[RENDERER] ✅ Model loaded: ${e}`))}catch(t){console.error(`[RENDERER] Failed to load model ${e}:`,t),"glasses2"!==e&&await this.loadModel("glasses2")}}async _loadModel(e){if("demo"===e)return this._createModelAnchor(this._createDemoModel());try{const t=new Xe,s=(await t.loadAsync(`./assets/models/${e}/${e}.glb`)).scene;return s.traverse(e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0,e.material&&(e.material.transparent=!0,e.material.opacity=.9))}),this._normalizeModelDimensions(s),this._createModelAnchor(s)}catch(t){return console.warn(`[RENDERER] GLB model not found, creating demo: ${t.message}`),this._createModelAnchor(this._createDemoModel())}}_normalizeModelDimensions(e){const t=(new ue).setFromObject(e);if(t.isEmpty())return;const s=new v;t.getCenter(s),e.position.sub(s);const n=new v;t.getSize(n);const i=145/Math.max(n.x,1);e.scale.multiplyScalar(i)}_createModelAnchor(e){const t=new W;return t.name="glassesAnchor",t.add(e),t}_createDemoModel(){const e=new W,t=new c({color:3355443,metalness:.1,roughness:.2,clearcoat:.3,transparent:!0,opacity:.9}),s=new c({color:16777215,metalness:0,roughness:0,transmission:.9,transparent:!0,opacity:.3}),n=new Ae(80,4,8,100),i=new K(n,t);i.position.set(-40,0,0),i.rotation.z=Math.PI/2;const a=new K(n,t);a.position.set(40,0,0),a.rotation.z=Math.PI/2;const r=new ye(35,32),o=new K(r,s);o.position.set(-40,0,2);const l=new K(r,s);l.position.set(40,0,2);const h=new Ee(2,2,20,8),d=new K(h,t);d.rotation.z=Math.PI/2;const u=new Ee(2,3,100,8),m=new K(u,t);m.position.set(-80,0,-30),m.rotation.z=Math.PI/6,m.name="leftTemple";const f=new K(u,t);return f.position.set(80,0,-30),f.rotation.z=-Math.PI/6,f.name="rightTemple",e.add(i),e.add(a),e.add(o),e.add(l),e.add(d),e.add(m),e.add(f),e.scale.set(1,1,1),console.log("[RENDERER] Demo model created"),e}updateFromTrackingData(e){if(this.glassesModel&&e)try{this._updateTransform(e),this._updateScale(e),this._updateTempleAngles(e),this._updateOpacity(e),this.renderer.render(this.scene,this.camera)}catch(t){console.error("[RENDERER] Update failed:",t)}}_updateTransform(e){const{rvec:t,tvec:s,sellionOffset:n}=e;if(!t||!s||!n)return;const i=new y,a=Math.hypot(t[0],t[1],t[2]);if(a>1e-6){const e=new v(t[0]/a,t[1]/a,t[2]/a);i.setFromAxisAngle(e,a)}else i.identity();const r=new v(n.x*this.canvas.width-this.canvas.width/2,-(n.y*this.canvas.height-this.canvas.height/2),100*n.z);this.glassesModel.position.copy(r),this.glassesModel.quaternion.copy(i)}_updateScale(e){const{scale:t}=e;t&&this.glassesModel.scale.set(t.x,t.y,t.z)}_updateTempleAngles(e){const{templeAngle:t,templeAngleData:s}=e;null!=t&&this.templeAdjuster&&this.templeAdjuster.updateTempleAngles(this.glassesModel,t,s)}_updateOpacity(e){const{effectiveConfidence:t}=e;this.targetOpacity=t>.5?1:2*t,this.opacity+=.1*(this.targetOpacity-this.opacity),this.glassesModel&&this.glassesModel.traverse(e=>{e.isMesh&&e.material&&(e.material.opacity=this.opacity)})}fadeOut(){this.targetOpacity=0}_disposeModel(e){e.traverse(e=>{e.isMesh&&(e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(e=>e.dispose()):e.material.dispose()))})}onResize(e,t){this.camera&&(this.camera.aspect=e/t,this.camera.updateProjectionMatrix()),this.renderer&&this.renderer.setSize(e,t)}destroy(){console.log("[RENDERER] Destroying..."),this.glassesModel&&(this._disposeModel(this.glassesModel),this.scene.remove(this.glassesModel)),this.templeAdjuster&&this.templeAdjuster.destroy(),this.renderer&&this.renderer.dispose()}}class $t{constructor(){this.modal=document.getElementById("feedback-modal"),this.ratingButtons=null,this.commentTextarea=null,this.submitButton=null,this.skipButton=null,this.currentRating=0,this.isVisible=!1,this._initializeElements(),this._initializeEventListeners()}_initializeElements(){var e,t,s,n,i,a;this.modal&&(this.ratingButtons=this.modal.querySelectorAll(".rating-btn"),this.commentTextarea=(null==(t=(e=this.modal).getElementById)?void 0:t.call(e,"feedback-comment"))||this.modal.querySelector("#feedback-comment"),this.submitButton=(null==(n=(s=this.modal).getElementById)?void 0:n.call(s,"submit-feedback"))||this.modal.querySelector("#submit-feedback"),this.skipButton=(null==(a=(i=this.modal).getElementById)?void 0:a.call(i,"skip-feedback"))||this.modal.querySelector("#skip-feedback"))}_initializeEventListeners(){var e,t,s;this.modal&&(null==(e=this.ratingButtons)||e.forEach(e=>{e.addEventListener("click",e=>{this._handleRatingClick(e.target)})}),null==(t=this.submitButton)||t.addEventListener("click",()=>{this._handleSubmit()}),null==(s=this.skipButton)||s.addEventListener("click",()=>{this.hide()}),this.modal.addEventListener("click",e=>{e.target===this.modal&&this.hide()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&this.isVisible&&this.hide()}))}_handleRatingClick(e){var t;const s=parseInt(e.dataset.rating);this.currentRating=s,null==(t=this.ratingButtons)||t.forEach((e,t)=>{t<s?e.classList.add("selected"):e.classList.remove("selected")}),this.submitButton&&(this.submitButton.disabled=0===s)}_handleSubmit(){var e;if(0===this.currentRating)return void this._showError("Please select a rating");const t={rating:this.currentRating,comment:(null==(e=this.commentTextarea)?void 0:e.value)||"",timestamp:(new Date).toISOString(),userAgent:navigator.userAgent,sessionId:this._getSessionId()};this._saveFeedback(t),this._showSuccess("Thank you for your feedback!"),setTimeout(()=>{this.hide()},1500),this._resetForm()}_saveFeedback(e){try{const t=JSON.parse(localStorage.getItem("vto_feedback")||"[]");t.push(e),t.length>100&&t.splice(0,t.length-100),localStorage.setItem("vto_feedback",JSON.stringify(t)),console.log("[FEEDBACK] Feedback saved:",e)}catch(t){console.error("[FEEDBACK] Failed to save feedback:",t)}}_getSessionId(){let e=sessionStorage.getItem("vto_session_id");return e||(e="session_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),sessionStorage.setItem("vto_session_id",e)),e}show(){var e;this.modal&&(this.isVisible=!0,this.modal.style.display="flex",this.modal.style.opacity="0",setTimeout(()=>{this.modal.style.opacity="1"},10),(null==(e=this.ratingButtons)?void 0:e.length)>0&&this.ratingButtons[0].focus())}hide(){this.modal&&(this.isVisible=!1,this.modal.style.opacity="0",setTimeout(()=>{this.modal.style.display="none"},300))}_resetForm(){var e;this.currentRating=0,null==(e=this.ratingButtons)||e.forEach(e=>{e.classList.remove("selected")}),this.commentTextarea&&(this.commentTextarea.value=""),this.submitButton&&(this.submitButton.disabled=!0)}_showError(e){var t,s;const n=document.createElement("div");n.className="feedback-error",n.textContent=e,null==(s=null==(t=this.modal)?void 0:t.querySelector(".modal-content"))||s.appendChild(n),setTimeout(()=>{n.remove()},3e3)}_showSuccess(e){var t,s;const n=document.createElement("div");n.className="feedback-success",n.textContent=e,null==(s=null==(t=this.modal)?void 0:t.querySelector(".modal-content"))||s.appendChild(n),setTimeout(()=>{n.remove()},3e3)}static getAllFeedback(){try{return JSON.parse(localStorage.getItem("vto_feedback")||"[]")}catch(e){return console.error("[FEEDBACK] Failed to load feedback:",e),[]}}static exportFeedback(){const e=this.getAllFeedback(),t=JSON.stringify(e,null,2),s="data:application/json;charset=utf-8,"+encodeURIComponent(t),n=`vto_feedback_${(new Date).toISOString().split("T")[0]}.json`,i=document.createElement("a");i.setAttribute("href",s),i.setAttribute("download",n),i.click()}static getFeedbackStats(){const e=this.getAllFeedback();if(0===e.length)return{total:0,averageRating:0,ratingDistribution:{}};const t=e.reduce((e,t)=>e+t.rating,0)/e.length,s={};return e.forEach(e=>{s[e.rating]=(s[e.rating]||0)+1}),{total:e.length,averageRating:t.toFixed(2),ratingDistribution:s}}static clearAllFeedback(){localStorage.removeItem("vto_feedback"),console.log("[FEEDBACK] All feedback cleared")}destroy(){var e,t,s;null==(e=this.ratingButtons)||e.forEach(e=>{e.removeEventListener("click",this._handleRatingClick)}),null==(t=this.submitButton)||t.removeEventListener("click",this._handleSubmit),null==(s=this.skipButton)||s.removeEventListener("click",this.hide),document.removeEventListener("keydown",e=>{"Escape"===e.key&&this.isVisible&&this.hide()}),console.log("[FEEDBACK] FeedbackForm destroyed")}}class qt{constructor(e={}){this.options=e,this.feedbackForm=new $t,this.loadingScreen=document.getElementById("loading-screen"),this.mainContent=document.getElementById("main-content"),this.calibrationUI=document.getElementById("calibration-ui"),this.confidenceIndicator=document.getElementById("confidence-indicator"),this.featuresBadge=document.getElementById("features-badge"),this.instructions=document.getElementById("instructions"),this.frameSelector=document.getElementById("frame-selector"),this.calProgressBar=document.getElementById("cal-progress-bar"),this.calCurrent=document.getElementById("cal-current"),this.calTotal=document.getElementById("cal-total"),this.confidenceFill=document.getElementById("confidence-fill"),this.badgeText=document.getElementById("badge-text"),this._initializeEventListeners(),this._loadFrameLibrary()}_initializeEventListeners(){var e;window.addEventListener("resize",()=>this._handleResize()),this.frameSelector&&this.frameSelector.addEventListener("click",e=>{var t,s;const n=e.target.closest(".frame-option");if(!n||!this.frameSelector.contains(n))return;const i=n.dataset.frameId;this._setSelectedFrame(i),null==(s=(t=this.options).onFrameSelected)||s.call(t,i)});const t=null==(e=this.instructions)?void 0:e.querySelector(".instructions-box");t&&t.addEventListener("click",()=>{this.hideInstructions()})}async _loadFrameLibrary(){try{const e=await fetch("./assets/config/frameLibrary.json"),t=await e.json();this._populateFrameSelector(t.frames)}catch(e){console.warn("[UI] Failed to load frame library:",e),this._populateFrameSelector(this._getDefaultFrames())}}_populateFrameSelector(e){this.frameSelector&&(this.frameSelector.innerHTML="",e.forEach(e=>{const t=document.createElement("div");t.className="frame-option",t.dataset.frameId=e.id,t.innerHTML=`\n        <div class="frame-thumbnail">\n          <img src="${e.thumbnail||"./assets/images/placeholder-frame.png"}" alt="${e.name}">\n        </div>\n        <div class="frame-info">\n          <div class="frame-name">${e.name}</div>\n          <div class="frame-price">${e.price||""}</div>\n        </div>\n      `,this.frameSelector.appendChild(t)}),this._setSelectedFrame("glasses2"))}_setSelectedFrame(e){this.frameSelector&&this.frameSelector.querySelectorAll(".frame-option").forEach(t=>{t.dataset.frameId===e?t.classList.add("selected"):t.classList.remove("selected")})}_getDefaultFrames(){return[{id:"glasses2",name:"Glasses 2",price:"INR 3999"}]}updateCalibrationProgress(e,t){if(this.calProgressBar){const s=e/t*100;this.calProgressBar.style.width=`${s}%`}this.calCurrent&&(this.calCurrent.textContent=e),this.calTotal&&(this.calTotal.textContent=t)}updateConfidence(e){if(!this.confidenceFill)return;const t=Math.max(0,Math.min(100,100*e));this.confidenceFill.style.width=`${t}%`,this.confidenceFill.style.backgroundColor=e>.7?"#4CAF50":e>.4?"#FF9800":"#F44336"}updateEarDetectionStatus(e){var t,s;this.badgeText&&(e?(this.badgeText.textContent="Ear Detection Active",null==(t=this.featuresBadge)||t.classList.add("active")):(this.badgeText.textContent="Ear Detection Inactive",null==(s=this.featuresBadge)||s.classList.remove("active")))}updateTrackingState(e){switch(e){case"TRACKING":this._showTrackingActive();break;case"LOST":this._showTrackingLost();break;case"CALIBRATING":this._showCalibrating()}}_showTrackingActive(){var e,t;null==(e=this.confidenceIndicator)||e.classList.add("active"),null==(t=this.featuresBadge)||t.classList.add("active")}_showTrackingLost(){var e;null==(e=this.confidenceIndicator)||e.classList.remove("active"),this.updateConfidence(0)}_showCalibrating(){var e;null==(e=this.calibrationUI)||e.classList.add("active")}showMainContent(){this.mainContent&&(this.mainContent.style.display="block",this.mainContent.style.opacity="1")}hideCalibration(){this.calibrationUI&&(this.calibrationUI.style.opacity="0",setTimeout(()=>{this.calibrationUI.style.display="none"},300))}showInstructions(){this.instructions&&(this.instructions.style.display="block",this.instructions.style.opacity="1",setTimeout(()=>{this.hideInstructions()},1e4))}hideInstructions(){this.instructions&&(this.instructions.style.opacity="0",setTimeout(()=>{this.instructions.style.display="none"},300))}showFeedbackModal(){this.feedbackForm.show()}_handleResize(){const e=document.getElementById("tracking-canvas"),t=document.getElementById("user-video");e&&t&&(e.width=t.videoWidth||window.innerWidth,e.height=t.videoHeight||window.innerHeight)}showError(e,t=5e3){const s=document.createElement("div");s.className="error-toast",s.innerHTML=`\n      <div class="error-content">\n        <span class="error-icon">⚠️</span>\n        <span class="error-message">${e}</span>\n        <button class="error-close" onclick="this.parentElement.parentElement.remove()">×</button>\n      </div>\n    `,document.body.appendChild(s),setTimeout(()=>{s.parentElement&&s.remove()},t)}showSuccess(e,t=3e3){const s=document.createElement("div");s.className="success-toast",s.innerHTML=`\n      <div class="success-content">\n        <span class="success-icon">✅</span>\n        <span class="success-message">${e}</span>\n        <button class="success-close" onclick="this.parentElement.parentElement.remove()">×</button>\n      </div>\n    `,document.body.appendChild(s),setTimeout(()=>{s.parentElement&&s.remove()},t)}getState(){var e,t,s,n,i;return{calibrationVisible:"none"!==(null==(e=this.calibrationUI)?void 0:e.style.display),instructionsVisible:"none"!==(null==(t=this.instructions)?void 0:t.style.display),confidenceLevel:(null==(s=this.confidenceFill)?void 0:s.style.width)||"0%",earDetectionActive:(null==(i=null==(n=this.badgeText)?void 0:n.textContent)?void 0:i.includes("Active"))||!1}}destroy(){this.feedbackForm&&this.feedbackForm.destroy(),window.removeEventListener("resize",this._handleResize),console.log("[UI] UIManager destroyed")}}class Xt{constructor(){this.sessionId=this._generateSessionId(),this.events=[],this.startTime=Date.now(),this.deviceInfo=this._getDeviceInfo(),this.isEnabled=!0,this._loadEvents(),this._setupAutoSave(),console.log("[ANALYTICS] Analytics initialized with session:",this.sessionId)}_generateSessionId(){const e=sessionStorage.getItem("vto_analytics_session");if(e)return e;const t="session_"+Date.now()+"_"+Math.random().toString(36).substr(2,9);return sessionStorage.setItem("vto_analytics_session",t),t}_getDeviceInfo(){return{userAgent:navigator.userAgent,platform:navigator.platform,language:navigator.language,screenResolution:`${screen.width}x${screen.height}`,pixelRatio:window.devicePixelRatio||1,hardwareConcurrency:navigator.hardwareConcurrency||"unknown",deviceMemory:navigator.deviceMemory||"unknown",timestamp:(new Date).toISOString()}}_loadEvents(){try{const e=localStorage.getItem("vto_analytics_events");e&&(this.events=JSON.parse(e))}catch(e){console.error("[ANALYTICS] Failed to load events:",e),this.events=[]}}_setupAutoSave(){setInterval(()=>{this._saveEvents()},3e4),window.addEventListener("beforeunload",()=>{this._saveEvents()})}trackEvent(e,t={}){if(!this.isEnabled)return;const s={id:this._generateEventId(),sessionId:this.sessionId,eventName:e,timestamp:Date.now(),data:t,deviceInfo:this.deviceInfo,sessionDuration:Date.now()-this.startTime};this.events.push(s),this.events.length>1e3&&(this.events=this.events.slice(-1e3)),console.log("[ANALYTICS] Event tracked:",e,t)}_generateEventId(){return"event_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}_saveEvents(){try{localStorage.setItem("vto_analytics_events",JSON.stringify(this.events))}catch(e){console.error("[ANALYTICS] Failed to save events:",e)}}trackAppInit(e={}){this.trackEvent("app_initialized",{loadTime:e.loadTime||0,opencvLoaded:e.opencvLoaded||!1,mediapipeLoaded:e.mediapipeLoaded||!1,...e})}trackCameraAccess(e,t=null){this.trackEvent("camera_access",{success:e,error:t?t.message:null,timestamp:Date.now()})}trackCalibration(e,t={}){this.trackEvent("calibration",{status:e,...t})}trackFrameSelection(e,t={}){this.trackEvent("frame_selected",{frameId:e,...t})}trackTrackingQuality(e,t){this.trackEvent("tracking_quality",{confidence:e,state:t,timestamp:Date.now()})}trackEarDetection(e,t=0){this.trackEvent("ear_detection",{detected:e,confidence:t,timestamp:Date.now()})}trackPerformance(e){this.trackEvent("performance",{fps:e.fps,frameTime:e.frameTime,memoryUsage:e.memoryUsage,timestamp:Date.now()})}trackError(e,t={}){this.trackEvent("error",{message:e.message,stack:e.stack,context:t,timestamp:Date.now()})}trackInteraction(e,t,s={}){this.trackEvent("user_interaction",{action:e,target:t,...s})}getSummary(){const e={totalEvents:this.events.length,sessionDuration:Date.now()-this.startTime,sessionId:this.sessionId,deviceInfo:this.deviceInfo},t={};return this.events.forEach(e=>{t[e.eventName]=(t[e.eventName]||0)+1}),e.eventCounts=t,e.recentEvents=this.events.slice(-10),e}exportData(){const e={sessionId:this.sessionId,deviceInfo:this.deviceInfo,events:this.events,summary:this.getSummary(),exportTime:(new Date).toISOString()},t=JSON.stringify(e,null,2),s="data:application/json;charset=utf-8,"+encodeURIComponent(t),n=`vto_analytics_${this.sessionId}.json`,i=document.createElement("a");i.setAttribute("href",s),i.setAttribute("download",n),i.click(),console.log("[ANALYTICS] Analytics data exported")}clearData(){this.events=[],localStorage.removeItem("vto_analytics_events"),console.log("[ANALYTICS] Analytics data cleared")}setEnabled(e){this.isEnabled=e,console.log("[ANALYTICS] Analytics",e?"enabled":"disabled")}getEventsByType(e){return this.events.filter(t=>t.eventName===e)}getEventsInTimeRange(e,t){return this.events.filter(s=>s.timestamp>=e&&s.timestamp<=t)}getSessionStats(){if(0===this.events.length)return null;const e=this.startTime,t=Date.now(),s=t-e,n=new Set(this.events.map(e=>e.eventName)),i=this.getEventsByType("tracking_quality"),a=i.length>0?i.reduce((e,t)=>e+(t.data.confidence||0),0)/i.length:0;return{sessionId:this.sessionId,duration:s,durationFormatted:this._formatDuration(s),totalEvents:this.events.length,uniqueEvents:n.size,averageTrackingConfidence:a.toFixed(3),startTime:new Date(e).toISOString(),endTime:new Date(t).toISOString()}}_formatDuration(e){const t=Math.floor(e/1e3),s=Math.floor(t/60),n=Math.floor(s/60);return n>0?`${n}h ${s%60}m ${t%60}s`:s>0?`${s}m ${t%60}s`:`${t}s`}destroy(){this._saveEvents(),console.log("[ANALYTICS] Analytics destroyed")}}new Xt;let Wt=null,Yt=null,Jt=null,Qt=null,Zt=!1;const es=document.getElementById("user-video"),ts=document.getElementById("tracking-canvas"),ss=document.getElementById("glasses-canvas"),ns=document.getElementById("loading-screen"),is=document.getElementById("main-content"),as=document.getElementById("loading-message"),rs=document.getElementById("loading-progress");async function os(){try{cs(10,"Loading OpenCV.js..."),await new Promise((e,t)=>{if(window.opencvReady&&"undefined"!=typeof cv)return console.log("[INIT] OpenCV.js already loaded"),void e();const s=setTimeout(()=>{t(new Error("OpenCV.js failed to load within 30 seconds"))},3e4);window.addEventListener("opencvLoaded",()=>{clearTimeout(s),console.log("[INIT] OpenCV.js loaded successfully"),e()});const n=setInterval(()=>{window.opencvReady&&"undefined"!=typeof cv&&(clearTimeout(s),clearInterval(n),console.log("[INIT] OpenCV.js detected"),e())},100)}),cs(30,"OpenCV loaded. Initializing trackers..."),cs(40,"Requesting camera access...");const t=new Te;try{Jt=await t.requestCameraStreamEnhanced(),es.srcObject=Jt,await es.play()}catch(e){throw console.error("[MAIN] Camera setup failed:",e),new Error(`Camera access failed: ${e.message}`)}ts.width=es.videoWidth||1280,ts.height=es.videoHeight||720,cs(60,"Initializing face tracker...");const s=new qt({onFrameSelected:e=>{!async function(e){try{await Yt.loadModel(e),Xt.trackEvent("frame_selected",{frameId:e})}catch(t){console.error(`[MAIN] Failed to load frame ${e}:`,t),await hs()}}(e)}});Wt=new $e(es,ts,{onCalibrated:()=>{s.hideCalibration(),s.showInstructions()},onCalibrationProgress:(e,t)=>{s.updateCalibrationProgress(e,t)},onConfidenceUpdate:e=>{s.updateConfidence(e)},onEarDetection:e=>{s.updateEarDetectionStatus(e)},onTrackingStateChange:e=>{s.updateTrackingState(e)}}),cs(80,"Setting up 3D renderer..."),ss?(ss.width=ts.width,ss.height=ts.height,Yt=new Vt(ss)):Yt=new Vt(ts),await hs(),cs(95,"Finalizing setup..."),setTimeout(()=>{!function(){async function e(){if(Zt&&Wt&&Yt){try{const e=await Wt.processFrame(performance.now());e&&e.effectiveConfidence>.35?(Yt.updateFromTrackingData(e),Xt.trackEvent("frame_rendered")):Yt.fadeOut()}catch(t){console.error("[MAIN] Render error:",t)}Qt=requestAnimationFrame(e)}else Qt=requestAnimationFrame(e)}e()}(),s.showMainContent(),ls(),Zt=!0,Xt.trackEvent("app_initialized"),cs(100,"Ready!"),setTimeout(ls,500)},300)}catch(t){console.error("[MAIN] Initialization failed:",t),function(e){ls();document.getElementById("app").innerHTML=`\n    <div class="error-screen centered">\n      <div class="error-content">\n        <div class="error-icon">⚠️</div>\n        <h2>Initialization Failed</h2>\n        <p>${e}</p>\n        <div class="error-details">\n          <p>✅ Use Chrome/Firefox on desktop or modern mobile</p>\n          <p>✅ Allow camera permissions</p>\n          <p>✅ Ensure good lighting</p>\n          <p>✅ Refresh page if loading fails</p>\n        </div>\n        <button onclick="location.reload()" class="btn-primary">Retry</button>\n      </div>\n    </div>\n  `}(t.message||"Failed to initialize application")}}function cs(e,t){rs&&(rs.style.width=`${e}%`),as&&(as.textContent=t)}function ls(){ns&&(ns.style.opacity="0",setTimeout(()=>{ns.style.display="none"},300)),is&&(is.style.display="block")}async function hs(){try{await Yt.loadModel("glasses2"),Xt.trackEvent("frame_loaded",{frameId:"glasses2"})}catch(e){console.error("[MAIN] Failed to load default frame:",e)}}function ds(){Qt&&cancelAnimationFrame(Qt),Wt&&Wt.destroy(),Yt&&Yt.destroy(),Jt&&Jt.getTracks().forEach(e=>e.stop()),Xt.trackEvent("app_destroyed")}window.addEventListener("beforeunload",ds),window.addEventListener("unload",ds),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",os):os(),window.app={faceTracker:Wt,glassesRenderer:Yt,reload:()=>location.reload(),exportFeedback:()=>{const e=localStorage.getItem("vto_feedback");return e?(console.log("Customer Feedback:",JSON.parse(e)),JSON.parse(e)):[]}};
//# sourceMappingURL=index-D_GcyiRi.js.map
